package com.eduscheduler.controller.api;

import com.eduscheduler.controller.api.MobileApiController.*;
import com.eduscheduler.model.domain.Student;
import com.eduscheduler.repository.StudentRepository;
import com.eduscheduler.service.impl.AttendanceService;
import com.eduscheduler.service.impl.TranscriptService;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.test.context.ActiveProfiles;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.List;
import java.util.Map;

import static org.junit.jupiter.api.Assertions.*;

/**
 * Integration tests for MobileApiController
 * Tests mobile-optimized API endpoints for iOS/Android applications
 *
 * @author EduScheduler Pro Team
 * @version 1.0.0
 * @since December 19, 2025 - Controller Layer Test Coverage
 */
@SpringBootTest(classes = com.eduscheduler.EduSchedulerApiApplication.class)
@ActiveProfiles("test")
@Transactional
public class MobileApiControllerTest {

    @Autowired
    private MobileApiController mobileApiController;

    @Autowired
    private StudentRepository studentRepository;

    private Student testStudent;

    private static final Long TEST_USER_ID = 12345L;
    private static final String TEST_DEVICE_ID = "MOBILE_TEST_DEVICE_001";

    @BeforeEach
    public void setup() {
        // Create test student
        testStudent = new Student();
        testStudent.setStudentId("MOBILE_STUDENT_001");
        testStudent.setFirstName("Mobile");
        testStudent.setLastName("Test");
        testStudent.setGradeLevel("11");  // Required field
        testStudent.setEmail("mobile.test@student.edu");
        testStudent = studentRepository.save(testStudent);
    }

    // ========================================================================
    // TEST 1: SCHEDULE ENDPOINTS
    // ========================================================================

    @Test
    public void testGetStudentSchedule_WithValidStudentAndDefaultDate_ShouldSucceed() {
        // Act
        ResponseEntity<MobileScheduleResponse> response =
            mobileApiController.getStudentSchedule(testStudent.getId(), null);

        // Assert
        assertEquals(HttpStatus.OK, response.getStatusCode(), "Should return OK status");
        assertNotNull(response.getBody(), "Response body should be present");

        MobileScheduleResponse schedule = response.getBody();
        assertEquals(testStudent.getId(), schedule.getStudentId(), "Should match student ID");
        assertNotNull(schedule.getDate(), "Date should be set to today");
        assertNotNull(schedule.getDayOfWeek(), "Day of week should be present");
        assertNotNull(schedule.getPeriods(), "Periods list should be initialized");
        assertNotNull(schedule.getLastUpdated(), "Last updated timestamp should be present");

        System.out.println("✓ Student schedule retrieved successfully");
        System.out.println("  - Student ID: " + schedule.getStudentId());
        System.out.println("  - Date: " + schedule.getDate());
        System.out.println("  - Day: " + schedule.getDayOfWeek());
        System.out.println("  - Periods: " + schedule.getPeriods().size());
    }

    @Test
    public void testGetStudentSchedule_WithSpecificDate_ShouldSucceed() {
        // Arrange
        LocalDate specificDate = LocalDate.of(2025, 12, 15);

        // Act
        ResponseEntity<MobileScheduleResponse> response =
            mobileApiController.getStudentSchedule(testStudent.getId(), specificDate);

        // Assert
        assertEquals(HttpStatus.OK, response.getStatusCode(), "Should return OK status");
        assertNotNull(response.getBody(), "Response body should be present");

        MobileScheduleResponse schedule = response.getBody();
        assertEquals(specificDate, schedule.getDate(), "Should match requested date");
        assertEquals("SUNDAY", schedule.getDayOfWeek(), "Should be SUNDAY for Dec 15, 2025");

        System.out.println("✓ Student schedule retrieved for specific date");
        System.out.println("  - Date: " + schedule.getDate());
        System.out.println("  - Day: " + schedule.getDayOfWeek());
    }

    @Test
    public void testGetStudentSchedule_ShouldReturnLightweightMobileResponse() {
        // Act
        ResponseEntity<MobileScheduleResponse> response =
            mobileApiController.getStudentSchedule(testStudent.getId(), null);

        // Assert
        assertEquals(HttpStatus.OK, response.getStatusCode(), "Should return OK status");
        assertNotNull(response.getBody(), "Response body should be present");

        MobileScheduleResponse schedule = response.getBody();
        // Verify lightweight response structure
        assertNotNull(schedule.getStudentId(), "Should include student ID");
        assertNotNull(schedule.getDate(), "Should include date");
        assertNotNull(schedule.getPeriods(), "Should include periods list");

        System.out.println("✓ Mobile response is lightweight and optimized");
    }

    @Test
    public void testGetStudentWeekSchedule_WithDefaultWeekStart_ShouldSucceed() {
        // Act
        ResponseEntity<MobileWeekScheduleResponse> response =
            mobileApiController.getStudentWeekSchedule(testStudent.getId(), null);

        // Assert
        assertEquals(HttpStatus.OK, response.getStatusCode(), "Should return OK status");
        assertNotNull(response.getBody(), "Response body should be present");

        MobileWeekScheduleResponse weekSchedule = response.getBody();
        assertEquals(testStudent.getId(), weekSchedule.getStudentId(), "Should match student ID");
        assertNotNull(weekSchedule.getWeekStart(), "Week start should be set");
        assertNotNull(weekSchedule.getWeekEnd(), "Week end should be set");
        assertNotNull(weekSchedule.getDays(), "Days list should be initialized");
        assertNotNull(weekSchedule.getLastUpdated(), "Last updated timestamp should be present");

        // Verify week span is 5 days (Monday-Friday)
        long daysDifference = java.time.temporal.ChronoUnit.DAYS.between(
            weekSchedule.getWeekStart(), weekSchedule.getWeekEnd());
        assertEquals(4, daysDifference, "Week should span 5 days (0-4 difference)");

        System.out.println("✓ Weekly schedule retrieved successfully");
        System.out.println("  - Week: " + weekSchedule.getWeekStart() + " to " + weekSchedule.getWeekEnd());
        System.out.println("  - Days: " + weekSchedule.getDays().size());
    }

    @Test
    public void testGetStudentWeekSchedule_WithSpecificWeekStart_ShouldSucceed() {
        // Arrange
        LocalDate specificWeekStart = LocalDate.of(2025, 12, 8); // Monday

        // Act
        ResponseEntity<MobileWeekScheduleResponse> response =
            mobileApiController.getStudentWeekSchedule(testStudent.getId(), specificWeekStart);

        // Assert
        assertEquals(HttpStatus.OK, response.getStatusCode(), "Should return OK status");
        assertNotNull(response.getBody(), "Response body should be present");

        MobileWeekScheduleResponse weekSchedule = response.getBody();
        assertEquals(specificWeekStart, weekSchedule.getWeekStart(), "Should match requested week start");

        System.out.println("✓ Weekly schedule retrieved for specific week");
    }

    // ========================================================================
    // TEST 2: ATTENDANCE ENDPOINTS
    // ========================================================================

    @Test
    public void testGetAttendanceSummary_WithDefaultDateRange_ShouldSucceed() {
        // Act
        ResponseEntity<AttendanceService.AttendanceSummary> response =
            mobileApiController.getAttendanceSummary(testStudent.getId(), null, null);

        // Assert
        assertEquals(HttpStatus.OK, response.getStatusCode(), "Should return OK status");
        assertNotNull(response.getBody(), "Response body should be present");

        AttendanceService.AttendanceSummary summary = response.getBody();
        assertNotNull(summary, "Attendance summary should be present");

        System.out.println("✓ Attendance summary retrieved successfully");
        System.out.println("  - Total Days: " + summary.getTotalDays());
        System.out.println("  - Present Days: " + summary.getPresentDays());
        System.out.println("  - Absent Days: " + summary.getAbsentDays());
    }

    @Test
    public void testGetAttendanceSummary_WithSpecificDateRange_ShouldSucceed() {
        // Arrange
        LocalDate startDate = LocalDate.of(2025, 12, 1);
        LocalDate endDate = LocalDate.of(2025, 12, 15);

        // Act
        ResponseEntity<AttendanceService.AttendanceSummary> response =
            mobileApiController.getAttendanceSummary(testStudent.getId(), startDate, endDate);

        // Assert
        assertEquals(HttpStatus.OK, response.getStatusCode(), "Should return OK status");
        assertNotNull(response.getBody(), "Response body should be present");

        System.out.println("✓ Attendance summary retrieved for date range");
        System.out.println("  - Range: " + startDate + " to " + endDate);
    }

    // ========================================================================
    // TEST 3: GRADES ENDPOINTS
    // ========================================================================

    @Test
    public void testGetGradesSummary_WithValidStudent_ShouldSucceed() {
        // Act
        ResponseEntity<MobileGradesSummary> response =
            mobileApiController.getGradesSummary(testStudent.getId());

        // Assert
        assertEquals(HttpStatus.OK, response.getStatusCode(), "Should return OK status");
        assertNotNull(response.getBody(), "Response body should be present");

        MobileGradesSummary summary = response.getBody();
        assertEquals(testStudent.getId(), summary.getStudentId(), "Should match student ID");
        assertNotNull(summary.getCumulativeGpa(), "Cumulative GPA should be present");
        assertNotNull(summary.getWeightedGpa(), "Weighted GPA should be present");
        assertNotNull(summary.getTotalCredits(), "Total credits should be present");
        assertNotNull(summary.getClassRank(), "Class rank should be present");
        assertNotNull(summary.getClassSize(), "Class size should be present");
        assertNotNull(summary.getLastUpdated(), "Last updated timestamp should be present");

        System.out.println("✓ Grades summary retrieved successfully");
        System.out.println("  - Cumulative GPA: " + summary.getCumulativeGpa());
        System.out.println("  - Weighted GPA: " + summary.getWeightedGpa());
        System.out.println("  - Total Credits: " + summary.getTotalCredits());
        System.out.println("  - Class Rank: " + summary.getClassRank() + " / " + summary.getClassSize());
    }

    @Test
    public void testGetGradesSummary_ShouldIncludeClassRankInfo() {
        // Act
        ResponseEntity<MobileGradesSummary> response =
            mobileApiController.getGradesSummary(testStudent.getId());

        // Assert
        assertEquals(HttpStatus.OK, response.getStatusCode(), "Should return OK status");
        assertNotNull(response.getBody(), "Response body should be present");

        MobileGradesSummary summary = response.getBody();
        assertTrue(summary.getClassRank() > 0, "Class rank should be positive");
        assertTrue(summary.getClassSize() > 0, "Class size should be positive");
        assertTrue(summary.getClassRank() <= summary.getClassSize(),
                   "Rank should not exceed class size");

        System.out.println("✓ Class rank info validated");
    }

    @Test
    public void testGetCurrentGrades_WithValidStudent_ShouldSucceed() {
        // Act
        ResponseEntity<List<MobileCurrentGrade>> response =
            mobileApiController.getCurrentGrades(testStudent.getId());

        // Assert
        assertEquals(HttpStatus.OK, response.getStatusCode(), "Should return OK status");
        assertNotNull(response.getBody(), "Response body should be present");

        List<MobileCurrentGrade> grades = response.getBody();
        assertNotNull(grades, "Grades list should be initialized");

        System.out.println("✓ Current grades retrieved successfully");
        System.out.println("  - Current Courses: " + grades.size());
    }

    // ========================================================================
    // TEST 4: NOTIFICATIONS ENDPOINTS
    // ========================================================================

    @Test
    public void testRegisterDevice_WithValidRequest_ShouldSucceed() {
        // Arrange
        DeviceRegistrationRequest request = new DeviceRegistrationRequest();
        request.setUserId(TEST_USER_ID);
        request.setDeviceId(TEST_DEVICE_ID);
        request.setDeviceType("iOS");
        request.setPushToken("VALID_PUSH_TOKEN_12345");
        request.setAppVersion("1.0.0");

        // Act
        ResponseEntity<Map<String, Object>> response =
            mobileApiController.registerDevice(request);

        // Assert
        assertEquals(HttpStatus.OK, response.getStatusCode(), "Should return OK status");
        assertNotNull(response.getBody(), "Response body should be present");

        Map<String, Object> result = response.getBody();
        assertTrue((Boolean) result.get("success"), "Registration should succeed");
        assertEquals("Device registered successfully", result.get("message"), "Should have success message");
        assertEquals(TEST_DEVICE_ID, result.get("deviceId"), "Should return device ID");

        System.out.println("✓ Device registered successfully");
        System.out.println("  - Device ID: " + result.get("deviceId"));
        System.out.println("  - Device Type: iOS");
    }

    @Test
    public void testRegisterDevice_WithAndroidDevice_ShouldSucceed() {
        // Arrange
        DeviceRegistrationRequest request = new DeviceRegistrationRequest();
        request.setUserId(TEST_USER_ID);
        request.setDeviceId("ANDROID_DEVICE_001");
        request.setDeviceType("Android");
        request.setPushToken("ANDROID_PUSH_TOKEN_12345");
        request.setAppVersion("1.0.0");

        // Act
        ResponseEntity<Map<String, Object>> response =
            mobileApiController.registerDevice(request);

        // Assert
        assertEquals(HttpStatus.OK, response.getStatusCode(), "Should return OK status");
        assertTrue((Boolean) response.getBody().get("success"), "Registration should succeed");

        System.out.println("✓ Android device registered successfully");
    }

    @Test
    public void testGetNotifications_WithValidUserId_ShouldSucceed() {
        // Act
        ResponseEntity<List<MobileNotification>> response =
            mobileApiController.getNotifications(TEST_USER_ID, 20);

        // Assert
        assertEquals(HttpStatus.OK, response.getStatusCode(), "Should return OK status");
        assertNotNull(response.getBody(), "Response body should be present");

        List<MobileNotification> notifications = response.getBody();
        assertNotNull(notifications, "Notifications list should be initialized");

        System.out.println("✓ Notifications retrieved successfully");
        System.out.println("  - Count: " + notifications.size());
    }

    @Test
    public void testGetNotifications_WithCustomLimit_ShouldSucceed() {
        // Act
        ResponseEntity<List<MobileNotification>> response =
            mobileApiController.getNotifications(TEST_USER_ID, 50);

        // Assert
        assertEquals(HttpStatus.OK, response.getStatusCode(), "Should return OK status");
        assertNotNull(response.getBody(), "Response body should be present");

        System.out.println("✓ Notifications retrieved with custom limit");
    }

    // ========================================================================
    // TEST 5: SYNC ENDPOINTS
    // ========================================================================

    @Test
    public void testGetChanges_WithValidSyncRequest_ShouldSucceed() {
        // Arrange
        LocalDateTime lastSync = LocalDateTime.now().minusHours(24);

        // Act
        ResponseEntity<SyncResponse> response =
            mobileApiController.getChanges(TEST_USER_ID, lastSync);

        // Assert
        assertEquals(HttpStatus.OK, response.getStatusCode(), "Should return OK status");
        assertNotNull(response.getBody(), "Response body should be present");

        SyncResponse syncResponse = response.getBody();
        assertNotNull(syncResponse.getSyncTimestamp(), "Sync timestamp should be present");
        assertNotNull(syncResponse.getScheduleChanges(), "Schedule changes should be initialized");
        assertNotNull(syncResponse.getGradeChanges(), "Grade changes should be initialized");
        assertNotNull(syncResponse.getAttendanceChanges(), "Attendance changes should be initialized");
        assertNotNull(syncResponse.getAnnouncementChanges(), "Announcement changes should be initialized");

        System.out.println("✓ Sync changes retrieved successfully");
        System.out.println("  - Sync Timestamp: " + syncResponse.getSyncTimestamp());
        System.out.println("  - Has Changes: " + syncResponse.isHasChanges());
        System.out.println("  - Schedule Changes: " + syncResponse.getScheduleChanges().size());
        System.out.println("  - Grade Changes: " + syncResponse.getGradeChanges().size());
    }

    @Test
    public void testGetChanges_WithRecentLastSync_ShouldReturnNoChanges() {
        // Arrange
        LocalDateTime recentSync = LocalDateTime.now().minusMinutes(5);

        // Act
        ResponseEntity<SyncResponse> response =
            mobileApiController.getChanges(TEST_USER_ID, recentSync);

        // Assert
        assertEquals(HttpStatus.OK, response.getStatusCode(), "Should return OK status");
        assertNotNull(response.getBody(), "Response body should be present");

        SyncResponse syncResponse = response.getBody();
        assertFalse(syncResponse.isHasChanges(), "Should have no changes for recent sync");

        System.out.println("✓ Recent sync handled correctly (no changes)");
    }

    @Test
    public void testGetChanges_WithOldLastSync_ShouldIncludeTimestamp() {
        // Arrange
        LocalDateTime oldSync = LocalDateTime.now().minusDays(7);

        // Act
        ResponseEntity<SyncResponse> response =
            mobileApiController.getChanges(TEST_USER_ID, oldSync);

        // Assert
        assertEquals(HttpStatus.OK, response.getStatusCode(), "Should return OK status");
        assertNotNull(response.getBody(), "Response body should be present");

        SyncResponse syncResponse = response.getBody();
        assertTrue(syncResponse.getSyncTimestamp().isAfter(oldSync),
                   "New sync timestamp should be after old sync");

        System.out.println("✓ Old sync timestamp updated correctly");
    }

    // ========================================================================
    // TEST 6: VALIDATION AND EDGE CASES
    // ========================================================================

    @Test
    public void testGetStudentSchedule_ShouldDefaultToToday() {
        // Act
        ResponseEntity<MobileScheduleResponse> response =
            mobileApiController.getStudentSchedule(testStudent.getId(), null);

        // Assert
        assertEquals(HttpStatus.OK, response.getStatusCode(), "Should return OK status");
        MobileScheduleResponse schedule = response.getBody();
        assertEquals(LocalDate.now(), schedule.getDate(), "Should default to today");

        System.out.println("✓ Schedule defaults to today when date not specified");
    }

    @Test
    public void testGetAttendanceSummary_ShouldDefaultToCurrentMonth() {
        // Act
        ResponseEntity<AttendanceService.AttendanceSummary> response =
            mobileApiController.getAttendanceSummary(testStudent.getId(), null, null);

        // Assert
        assertEquals(HttpStatus.OK, response.getStatusCode(), "Should return OK status");
        // Defaults are: startDate = first day of current month, endDate = today

        System.out.println("✓ Attendance defaults to current month when dates not specified");
    }

    @Test
    public void testGetNotifications_ShouldDefaultToLimit20() {
        // Act - Not specifying limit in method, but testing default value
        ResponseEntity<List<MobileNotification>> response =
            mobileApiController.getNotifications(TEST_USER_ID, 20);

        // Assert
        assertEquals(HttpStatus.OK, response.getStatusCode(), "Should return OK status");

        System.out.println("✓ Notifications default limit verified (20)");
    }

    @Test
    public void testMobileResponses_ShouldBeOptimizedForBandwidth() {
        // Act - Get multiple mobile responses
        ResponseEntity<MobileScheduleResponse> scheduleResponse =
            mobileApiController.getStudentSchedule(testStudent.getId(), null);
        ResponseEntity<MobileGradesSummary> gradesResponse =
            mobileApiController.getGradesSummary(testStudent.getId());

        // Assert
        assertEquals(HttpStatus.OK, scheduleResponse.getStatusCode(), "Schedule should succeed");
        assertEquals(HttpStatus.OK, gradesResponse.getStatusCode(), "Grades should succeed");

        MobileScheduleResponse schedule = scheduleResponse.getBody();
        MobileGradesSummary grades = gradesResponse.getBody();

        // Verify lightweight structure (only essential fields)
        assertNotNull(schedule.getStudentId(), "Schedule has student ID");
        assertNotNull(schedule.getDate(), "Schedule has date");
        assertNotNull(grades.getCumulativeGpa(), "Grades has GPA");
        assertNotNull(grades.getClassRank(), "Grades has rank");

        System.out.println("✓ Mobile responses are optimized for bandwidth");
        System.out.println("  - Minimal fields included");
        System.out.println("  - Lightweight JSON structure");
    }

    @Test
    public void testSyncResponse_ShouldSupportOfflineMode() {
        // Act
        LocalDateTime lastSync = LocalDateTime.now().minusHours(12);
        ResponseEntity<SyncResponse> response =
            mobileApiController.getChanges(TEST_USER_ID, lastSync);

        // Assert
        assertEquals(HttpStatus.OK, response.getStatusCode(), "Should return OK status");
        SyncResponse syncResponse = response.getBody();

        // Verify all change types are included for offline sync
        assertNotNull(syncResponse.getScheduleChanges(), "Schedule changes for offline mode");
        assertNotNull(syncResponse.getGradeChanges(), "Grade changes for offline mode");
        assertNotNull(syncResponse.getAttendanceChanges(), "Attendance changes for offline mode");
        assertNotNull(syncResponse.getAnnouncementChanges(), "Announcement changes for offline mode");

        System.out.println("✓ Sync response supports offline mode");
        System.out.println("  - All change types included");
        System.out.println("  - Timestamp for next sync provided");
    }

    @Test
    public void testDeviceRegistration_ShouldSupportBothPlatforms() {
        // Test iOS
        DeviceRegistrationRequest iOSRequest = new DeviceRegistrationRequest();
        iOSRequest.setUserId(TEST_USER_ID);
        iOSRequest.setDeviceId("IOS_DEVICE_001");
        iOSRequest.setDeviceType("iOS");
        iOSRequest.setPushToken("IOS_TOKEN");
        iOSRequest.setAppVersion("1.0.0");

        ResponseEntity<Map<String, Object>> iOSResponse =
            mobileApiController.registerDevice(iOSRequest);

        // Test Android
        DeviceRegistrationRequest androidRequest = new DeviceRegistrationRequest();
        androidRequest.setUserId(TEST_USER_ID);
        androidRequest.setDeviceId("ANDROID_DEVICE_001");
        androidRequest.setDeviceType("Android");
        androidRequest.setPushToken("ANDROID_TOKEN");
        androidRequest.setAppVersion("1.0.0");

        ResponseEntity<Map<String, Object>> androidResponse =
            mobileApiController.registerDevice(androidRequest);

        // Assert
        assertEquals(HttpStatus.OK, iOSResponse.getStatusCode(), "iOS registration should succeed");
        assertEquals(HttpStatus.OK, androidResponse.getStatusCode(), "Android registration should succeed");

        System.out.println("✓ Both iOS and Android platforms supported");
    }
}
