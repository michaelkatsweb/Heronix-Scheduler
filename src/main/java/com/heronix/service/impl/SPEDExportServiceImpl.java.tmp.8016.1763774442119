package com.eduscheduler.service.impl;

import com.eduscheduler.model.domain.IEP;
import com.eduscheduler.model.domain.IEPService;
import com.eduscheduler.model.domain.PullOutSchedule;
import com.eduscheduler.model.domain.Teacher;
import com.eduscheduler.service.IEPManagementService;
import com.eduscheduler.service.PullOutSchedulingService;
import com.eduscheduler.service.SPEDComplianceService;
import com.eduscheduler.service.SPEDExportService;
import lombok.extern.slf4j.Slf4j;
import org.apache.poi.ss.usermodel.*;
import org.apache.poi.ss.util.CellRangeAddress;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.io.*;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.List;

/**
 * SPED Export Service Implementation
 *
 * Provides export functionality for SPED-related data.
 *
 * @author EduScheduler Pro Team
 * @version 1.0.0
 * @since Phase 8D - November 21, 2025
 */
@Service
@Slf4j
public class SPEDExportServiceImpl implements SPEDExportService {

    @Autowired
    private IEPManagementService iepManagementService;

    @Autowired
    private PullOutSchedulingService pullOutSchedulingService;

    @Autowired
    private SPEDComplianceService complianceService;

    private static final DateTimeFormatter DATE_FORMAT = DateTimeFormatter.ofPattern("yyyy-MM-dd");
    private static final DateTimeFormatter TIME_FORMAT = DateTimeFormatter.ofPattern("h:mm a");
    private static final DateTimeFormatter TIMESTAMP_FORMAT = DateTimeFormatter.ofPattern("yyyyMMdd_HHmmss");

    @Override
    public File exportComplianceReportPdf() throws Exception {
        log.info("Exporting SPED compliance report to PDF");
        // PDF generation would require a library like iText or Apache PDFBox
        // For now, we'll create a text-based report
        File exportDir = getExportsDirectory();
        String filename = "SPED_Compliance_Report_" + LocalDateTime.now().format(TIMESTAMP_FORMAT) + ".txt";
        File outputFile = new File(exportDir, filename);

        try (PrintWriter writer = new PrintWriter(new FileWriter(outputFile))) {
            writeComplianceReportText(writer);
        }

        log.info("Compliance report exported to: {}", outputFile.getAbsolutePath());
        return outputFile;
    }

    @Override
    public File exportComplianceReportExcel() throws Exception {
        log.info("Exporting SPED compliance report to Excel");
        File exportDir = getExportsDirectory();
        String filename = "SPED_Compliance_Report_" + LocalDateTime.now().format(TIMESTAMP_FORMAT) + ".xlsx";
        File outputFile = new File(exportDir, filename);

        try (Workbook workbook = new XSSFWorkbook()) {
            // Create summary sheet
            Sheet summarySheet = workbook.createSheet("Summary");
            createComplianceSummarySheet(workbook, summarySheet);

            // Create services sheet
            Sheet servicesSheet = workbook.createSheet("Services");
            createServicesSheet(workbook, servicesSheet);

            // Create IEPs sheet
            Sheet iepsSheet = workbook.createSheet("Active IEPs");
            createIepsSheet(workbook, iepsSheet);

            // Write to file
            try (FileOutputStream fos = new FileOutputStream(outputFile)) {
                workbook.write(fos);
            }
        }

        log.info("Compliance report exported to: {}", outputFile.getAbsolutePath());
        return outputFile;
    }

    @Override
    public File exportPullOutSchedulesPdf(List<PullOutSchedule> schedules) throws Exception {
        log.info("Exporting {} pull-out schedules to PDF", schedules.size());
        File exportDir = getExportsDirectory();
        String filename = "PullOut_Schedules_" + LocalDateTime.now().format(TIMESTAMP_FORMAT) + ".txt";
        File outputFile = new File(exportDir, filename);

        try (PrintWriter writer = new PrintWriter(new FileWriter(outputFile))) {
            writePullOutSchedulesText(writer, schedules);
        }

        log.info("Pull-out schedules exported to: {}", outputFile.getAbsolutePath());
        return outputFile;
    }

    @Override
    public File exportPullOutSchedulesExcel(List<PullOutSchedule> schedules) throws Exception {
        log.info("Exporting {} pull-out schedules to Excel", schedules.size());
        File exportDir = getExportsDirectory();
        String filename = "PullOut_Schedules_" + LocalDateTime.now().format(TIMESTAMP_FORMAT) + ".xlsx";
        File outputFile = new File(exportDir, filename);

        try (Workbook workbook = new XSSFWorkbook()) {
            Sheet sheet = workbook.createSheet("Pull-Out Schedules");
            createPullOutSchedulesSheet(workbook, sheet, schedules);

            try (FileOutputStream fos = new FileOutputStream(outputFile)) {
                workbook.write(fos);
            }
        }

        log.info("Pull-out schedules exported to: {}", outputFile.getAbsolutePath());
        return outputFile;
    }

    @Override
    public File exportPullOutSchedulesCsv(List<PullOutSchedule> schedules) throws Exception {
        log.info("Exporting {} pull-out schedules to CSV", schedules.size());
        File exportDir = getExportsDirectory();
        String filename = "PullOut_Schedules_" + LocalDateTime.now().format(TIMESTAMP_FORMAT) + ".csv";
        File outputFile = new File(exportDir, filename);

        try (PrintWriter writer = new PrintWriter(new FileWriter(outputFile))) {
            // Header
            writer.println("Student ID,Student Name,Service Type,Provider,Day,Start Time,End Time,Duration (min),Location,Status");

            // Data rows
            for (PullOutSchedule schedule : schedules) {
                writer.printf("%s,%s,%s,%s,%s,%s,%s,%d,%s,%s%n",
                    escapeCSV(schedule.getStudent() != null ? schedule.getStudent().getStudentId() : ""),
                    escapeCSV(schedule.getStudent() != null ? schedule.getStudent().getFullName() : ""),
                    escapeCSV(schedule.getServiceType()),
                    escapeCSV(schedule.getStaff() != null ? schedule.getStaff().getName() : "Unassigned"),
                    escapeCSV(schedule.getDayOfWeek()),
                    schedule.getStartTime() != null ? schedule.getStartTime().format(TIME_FORMAT) : "",
                    schedule.getEndTime() != null ? schedule.getEndTime().format(TIME_FORMAT) : "",
                    schedule.getDurationMinutes() != null ? schedule.getDurationMinutes() : 0,
                    escapeCSV(schedule.getLocationDisplay()),
                    schedule.getStatus() != null ? schedule.getStatus().name() : ""
                );
            }
        }

        log.info("Pull-out schedules exported to: {}", outputFile.getAbsolutePath());
        return outputFile;
    }

    @Override
    public File exportProviderWorkloadPdf(List<Teacher> providers) throws Exception {
        log.info("Exporting provider workload report to PDF");
        File exportDir = getExportsDirectory();
        String filename = "Provider_Workload_" + LocalDateTime.now().format(TIMESTAMP_FORMAT) + ".txt";
        File outputFile = new File(exportDir, filename);

        try (PrintWriter writer = new PrintWriter(new FileWriter(outputFile))) {
            writeProviderWorkloadText(writer, providers);
        }

        log.info("Provider workload report exported to: {}", outputFile.getAbsolutePath());
        return outputFile;
    }

    @Override
    public File exportProviderWorkloadExcel(List<Teacher> providers) throws Exception {
        log.info("Exporting provider workload report to Excel");
        File exportDir = getExportsDirectory();
        String filename = "Provider_Workload_" + LocalDateTime.now().format(TIMESTAMP_FORMAT) + ".xlsx";
        File outputFile = new File(exportDir, filename);

        try (Workbook workbook = new XSSFWorkbook()) {
            Sheet sheet = workbook.createSheet("Provider Workload");
            createProviderWorkloadSheet(workbook, sheet, providers);

            try (FileOutputStream fos = new FileOutputStream(outputFile)) {
                workbook.write(fos);
            }
        }

        log.info("Provider workload report exported to: {}", outputFile.getAbsolutePath());
        return outputFile;
    }

    @Override
    public File exportIepSummaryPdf(IEP iep) throws Exception {
        log.info("Exporting IEP summary to PDF: {}", iep.getIepNumber());
        File exportDir = getExportsDirectory();
        String filename = "IEP_" + iep.getIepNumber() + "_" + LocalDateTime.now().format(TIMESTAMP_FORMAT) + ".txt";
        File outputFile = new File(exportDir, filename);

        try (PrintWriter writer = new PrintWriter(new FileWriter(outputFile))) {
            writeIepSummaryText(writer, iep);
        }

        log.info("IEP summary exported to: {}", outputFile.getAbsolutePath());
        return outputFile;
    }

    @Override
    public File exportIepsSummaryExcel(List<IEP> ieps) throws Exception {
        log.info("Exporting {} IEPs summary to Excel", ieps.size());
        File exportDir = getExportsDirectory();
        String filename = "IEPs_Summary_" + LocalDateTime.now().format(TIMESTAMP_FORMAT) + ".xlsx";
        File outputFile = new File(exportDir, filename);

        try (Workbook workbook = new XSSFWorkbook()) {
            Sheet sheet = workbook.createSheet("IEPs Summary");
            createIepsSummarySheet(workbook, sheet, ieps);

            try (FileOutputStream fos = new FileOutputStream(outputFile)) {
                workbook.write(fos);
            }
        }

        log.info("IEPs summary exported to: {}", outputFile.getAbsolutePath());
        return outputFile;
    }

    @Override
    public File exportServiceDeliveryPdf(List<IEPService> services) throws Exception {
        log.info("Exporting service delivery report to PDF");
        File exportDir = getExportsDirectory();
        String filename = "Service_Delivery_" + LocalDateTime.now().format(TIMESTAMP_FORMAT) + ".txt";
        File outputFile = new File(exportDir, filename);

        try (PrintWriter writer = new PrintWriter(new FileWriter(outputFile))) {
            writeServiceDeliveryText(writer, services);
        }

        log.info("Service delivery report exported to: {}", outputFile.getAbsolutePath());
        return outputFile;
    }

    @Override
    public File exportServiceDeliveryExcel(List<IEPService> services) throws Exception {
        log.info("Exporting service delivery report to Excel");
        File exportDir = getExportsDirectory();
        String filename = "Service_Delivery_" + LocalDateTime.now().format(TIMESTAMP_FORMAT) + ".xlsx";
        File outputFile = new File(exportDir, filename);

        try (Workbook workbook = new XSSFWorkbook()) {
            Sheet sheet = workbook.createSheet("Service Delivery");
            createServiceDeliverySheet(workbook, sheet, services);

            try (FileOutputStream fos = new FileOutputStream(outputFile)) {
                workbook.write(fos);
            }
        }

        log.info("Service delivery report exported to: {}", outputFile.getAbsolutePath());
        return outputFile;
    }

    @Override
    public File getExportsDirectory() {
        File exportDir = new File(System.getProperty("user.home"), "EduScheduler/exports/sped");
        if (!exportDir.exists()) {
            exportDir.mkdirs();
        }
        return exportDir;
    }

    // ==================== Helper Methods ====================

    private void writeComplianceReportText(PrintWriter writer) {
        writer.println("=================================================================");
        writer.println("           SPED COMPLIANCE REPORT");
        writer.println("           Generated: " + LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss")));
        writer.println("=================================================================");
        writer.println();

        try {
            var metrics = complianceService.getDashboardMetrics();
            writer.println("SUMMARY");
            writer.println("-----------------------------------------------------------------");
            writer.printf("Total Active IEPs:           %d%n", metrics.totalActiveIEPs);
            writer.printf("Services Needing Scheduling: %d%n", metrics.servicesNeedingScheduling);
            writer.printf("Overall Compliance Rate:     %.1f%%%n", metrics.overallComplianceRate);
            writer.printf("IEPs Expiring Soon:          %d%n", metrics.iepsExpiringIn30Days);
            writer.println();

            // List expiring IEPs
            List<IEP> expiringIEPs = complianceService.getExpiringIEPs(30);
            if (!expiringIEPs.isEmpty()) {
                writer.println("IEPs EXPIRING IN NEXT 30 DAYS");
                writer.println("-----------------------------------------------------------------");
                for (IEP iep : expiringIEPs) {
                    writer.printf("- %s (%s) - Expires: %s%n",
                        iep.getStudent() != null ? iep.getStudent().getFullName() : "Unknown",
                        iep.getIepNumber(),
                        iep.getEndDate() != null ? iep.getEndDate().format(DATE_FORMAT) : "N/A"
                    );
                }
                writer.println();
            }

            // List services needing scheduling
            List<IEPService> unscheduledServices = complianceService.getServicesNeedingScheduling();
            if (!unscheduledServices.isEmpty()) {
                writer.println("SERVICES NEEDING SCHEDULING");
                writer.println("-----------------------------------------------------------------");
                for (IEPService service : unscheduledServices) {
                    writer.printf("- %s: %s (%d min/week)%n",
                        service.getStudent() != null ? service.getStudent().getFullName() : "Unknown",
                        service.getServiceType().getDisplayName(),
                        service.getMinutesPerWeek()
                    );
                }
            }

        } catch (Exception e) {
            writer.println("Error generating compliance data: " + e.getMessage());
            log.error("Error generating compliance report", e);
        }
    }

    private void writePullOutSchedulesText(PrintWriter writer, List<PullOutSchedule> schedules) {
        writer.println("=================================================================");
        writer.println("           PULL-OUT SCHEDULES REPORT");
        writer.println("           Generated: " + LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss")));
        writer.println("=================================================================");
        writer.println();
        writer.printf("Total Schedules: %d%n", schedules.size());
        writer.println();

        // Group by day
        String[] days = {"MONDAY", "TUESDAY", "WEDNESDAY", "THURSDAY", "FRIDAY"};
        for (String day : days) {
            List<PullOutSchedule> daySchedules = schedules.stream()
                .filter(s -> day.equals(s.getDayOfWeek()))
                .sorted((a, b) -> a.getStartTime().compareTo(b.getStartTime()))
                .toList();

            if (!daySchedules.isEmpty()) {
                writer.println(day);
                writer.println("-----------------------------------------------------------------");
                for (PullOutSchedule schedule : daySchedules) {
                    writer.printf("  %s - %s: %s - %s (%s)%n",
                        schedule.getStartTime().format(TIME_FORMAT),
                        schedule.getEndTime().format(TIME_FORMAT),
                        schedule.getStudent() != null ? schedule.getStudent().getFullName() : "Unknown",
                        schedule.getServiceType(),
                        schedule.getStaff() != null ? schedule.getStaff().getName() : "Unassigned"
                    );
                }
                writer.println();
            }
        }
    }

    private void writeProviderWorkloadText(PrintWriter writer, List<Teacher> providers) {
        writer.println("=================================================================");
        writer.println("           PROVIDER WORKLOAD REPORT");
        writer.println("           Generated: " + LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss")));
        writer.println("=================================================================");
        writer.println();

        for (Teacher provider : providers) {
            int workload = pullOutSchedulingService.getStaffWorkload(provider.getId());
            long sessionCount = pullOutSchedulingService.countStaffSchedules(provider.getId());

            writer.println(provider.getName());
            writer.println("-----------------------------------------------------------------");
            writer.printf("  Department:       %s%n", provider.getDepartment() != null ? provider.getDepartment() : "N/A");
            writer.printf("  Total Sessions:   %d%n", sessionCount);
            writer.printf("  Minutes/Week:     %d%n", workload);
            writer.println();
        }
    }

    private void writeIepSummaryText(PrintWriter writer, IEP iep) {
        writer.println("=================================================================");
        writer.println("           IEP SUMMARY");
        writer.println("           Generated: " + LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss")));
        writer.println("=================================================================");
        writer.println();

        writer.printf("IEP Number:      %s%n", iep.getIepNumber());
        writer.printf("Student:         %s%n", iep.getStudent() != null ? iep.getStudent().getFullName() : "Unknown");
        writer.printf("Status:          %s%n", iep.getStatus());
        writer.printf("Start Date:      %s%n", iep.getStartDate() != null ? iep.getStartDate().format(DATE_FORMAT) : "N/A");
        writer.printf("End Date:        %s%n", iep.getEndDate() != null ? iep.getEndDate().format(DATE_FORMAT) : "N/A");
        writer.printf("Next Review:     %s%n", iep.getNextReviewDate() != null ? iep.getNextReviewDate().format(DATE_FORMAT) : "N/A");
        writer.printf("Case Manager:    %s%n", iep.getCaseManager() != null ? iep.getCaseManager() : "N/A");
        writer.printf("Disability:      %s%n", iep.getPrimaryDisability() != null ? iep.getPrimaryDisability() : "N/A");
        writer.println();

        if (iep.getServices() != null && !iep.getServices().isEmpty()) {
            writer.println("SERVICES");
            writer.println("-----------------------------------------------------------------");
            for (IEPService service : iep.getServices()) {
                writer.printf("  %s: %d min/week (%s) - %s%n",
                    service.getServiceType().getDisplayName(),
                    service.getMinutesPerWeek(),
                    service.getDeliveryModel().getDisplayName(),
                    service.getStatus()
                );
            }
        }
    }

    private void writeServiceDeliveryText(PrintWriter writer, List<IEPService> services) {
        writer.println("=================================================================");
        writer.println("           SERVICE DELIVERY REPORT");
        writer.println("           Generated: " + LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss")));
        writer.println("=================================================================");
        writer.println();

        for (IEPService service : services) {
            writer.printf("%s - %s%n",
                service.getStudent() != null ? service.getStudent().getFullName() : "Unknown",
                service.getServiceType().getDisplayName()
            );
            writer.printf("  Required:   %d min/week%n", service.getMinutesPerWeek());
            writer.printf("  Scheduled:  %d min/week%n", service.getScheduledMinutesPerWeek());
            writer.printf("  Compliance: %.1f%%%n", service.getCompliancePercentage());
            writer.printf("  Status:     %s%n", service.getStatus());
            writer.println();
        }
    }

    // ==================== Excel Sheet Creation Methods ====================

    private void createComplianceSummarySheet(Workbook workbook, Sheet sheet) {
        CellStyle headerStyle = createHeaderStyle(workbook);
        CellStyle dataStyle = createDataStyle(workbook);

        int rowNum = 0;

        // Title
        Row titleRow = sheet.createRow(rowNum++);
        Cell titleCell = titleRow.createCell(0);
        titleCell.setCellValue("SPED Compliance Summary Report");
        titleCell.setCellStyle(headerStyle);
        sheet.addMergedRegion(new CellRangeAddress(0, 0, 0, 3));

        rowNum++; // Empty row

        try {
            var metrics = complianceService.getDashboardMetrics();

            // Metrics
            createDataRow(sheet, rowNum++, headerStyle, dataStyle, "Total Active IEPs", String.valueOf(metrics.totalActiveIEPs));
            createDataRow(sheet, rowNum++, headerStyle, dataStyle, "Services Needing Scheduling", String.valueOf(metrics.servicesNeedingScheduling));
            createDataRow(sheet, rowNum++, headerStyle, dataStyle, "Overall Compliance Rate", String.format("%.1f%%", metrics.overallComplianceRate));
            createDataRow(sheet, rowNum++, headerStyle, dataStyle, "IEPs Expiring in 30 Days", String.valueOf(metrics.iepsExpiringIn30Days));

        } catch (Exception e) {
            log.error("Error creating compliance summary sheet", e);
        }

        // Auto-size columns
        for (int i = 0; i < 4; i++) {
            sheet.autoSizeColumn(i);
        }
    }

    private void createServicesSheet(Workbook workbook, Sheet sheet) {
        CellStyle headerStyle = createHeaderStyle(workbook);

        // Header row
        Row headerRow = sheet.createRow(0);
        String[] headers = {"Student", "Service Type", "Required Min/Week", "Scheduled Min/Week", "Compliance %", "Status", "Provider"};
        for (int i = 0; i < headers.length; i++) {
            Cell cell = headerRow.createCell(i);
            cell.setCellValue(headers[i]);
            cell.setCellStyle(headerStyle);
        }

        try {
            List<IEP> activeIEPs = iepManagementService.findAllActiveIEPs();
            int rowNum = 1;

            for (IEP iep : activeIEPs) {
                if (iep.getServices() != null) {
                    for (IEPService service : iep.getServices()) {
                        Row row = sheet.createRow(rowNum++);
                        row.createCell(0).setCellValue(iep.getStudent() != null ? iep.getStudent().getFullName() : "");
                        row.createCell(1).setCellValue(service.getServiceType().getDisplayName());
                        row.createCell(2).setCellValue(service.getMinutesPerWeek());
                        row.createCell(3).setCellValue(service.getScheduledMinutesPerWeek());
                        row.createCell(4).setCellValue(String.format("%.1f%%", service.getCompliancePercentage()));
                        row.createCell(5).setCellValue(service.getStatus().getDisplayName());
                        row.createCell(6).setCellValue(service.getAssignedStaff() != null ? service.getAssignedStaff().getName() : "Unassigned");
                    }
                }
            }
        } catch (Exception e) {
            log.error("Error creating services sheet", e);
        }

        // Auto-size columns
        for (int i = 0; i < 7; i++) {
            sheet.autoSizeColumn(i);
        }
    }

    private void createIepsSheet(Workbook workbook, Sheet sheet) {
        CellStyle headerStyle = createHeaderStyle(workbook);

        // Header row
        Row headerRow = sheet.createRow(0);
        String[] headers = {"IEP Number", "Student", "Status", "Start Date", "End Date", "Next Review", "Case Manager", "Primary Disability", "Services Count"};
        for (int i = 0; i < headers.length; i++) {
            Cell cell = headerRow.createCell(i);
            cell.setCellValue(headers[i]);
            cell.setCellStyle(headerStyle);
        }

        try {
            List<IEP> activeIEPs = iepManagementService.findAllActiveIEPs();
            int rowNum = 1;

            for (IEP iep : activeIEPs) {
                Row row = sheet.createRow(rowNum++);
                row.createCell(0).setCellValue(iep.getIepNumber());
                row.createCell(1).setCellValue(iep.getStudent() != null ? iep.getStudent().getFullName() : "");
                row.createCell(2).setCellValue(iep.getStatus().toString());
                row.createCell(3).setCellValue(iep.getStartDate() != null ? iep.getStartDate().format(DATE_FORMAT) : "");
                row.createCell(4).setCellValue(iep.getEndDate() != null ? iep.getEndDate().format(DATE_FORMAT) : "");
                row.createCell(5).setCellValue(iep.getNextReviewDate() != null ? iep.getNextReviewDate().format(DATE_FORMAT) : "");
                row.createCell(6).setCellValue(iep.getCaseManager() != null ? iep.getCaseManager() : "");
                row.createCell(7).setCellValue(iep.getPrimaryDisability() != null ? iep.getPrimaryDisability() : "");
                row.createCell(8).setCellValue(iep.getServices() != null ? iep.getServices().size() : 0);
            }
        } catch (Exception e) {
            log.error("Error creating IEPs sheet", e);
        }

        // Auto-size columns
        for (int i = 0; i < 9; i++) {
            sheet.autoSizeColumn(i);
        }
    }

    private void createPullOutSchedulesSheet(Workbook workbook, Sheet sheet, List<PullOutSchedule> schedules) {
        CellStyle headerStyle = createHeaderStyle(workbook);

        // Header row
        Row headerRow = sheet.createRow(0);
        String[] headers = {"Student ID", "Student Name", "Service", "Provider", "Day", "Start Time", "End Time", "Duration (min)", "Location", "Status"};
        for (int i = 0; i < headers.length; i++) {
            Cell cell = headerRow.createCell(i);
            cell.setCellValue(headers[i]);
            cell.setCellStyle(headerStyle);
        }

        int rowNum = 1;
        for (PullOutSchedule schedule : schedules) {
            Row row = sheet.createRow(rowNum++);
            row.createCell(0).setCellValue(schedule.getStudent() != null ? schedule.getStudent().getStudentId() : "");
            row.createCell(1).setCellValue(schedule.getStudent() != null ? schedule.getStudent().getFullName() : "");
            row.createCell(2).setCellValue(schedule.getServiceType());
            row.createCell(3).setCellValue(schedule.getStaff() != null ? schedule.getStaff().getName() : "Unassigned");
            row.createCell(4).setCellValue(schedule.getDayOfWeek());
            row.createCell(5).setCellValue(schedule.getStartTime() != null ? schedule.getStartTime().format(TIME_FORMAT) : "");
            row.createCell(6).setCellValue(schedule.getEndTime() != null ? schedule.getEndTime().format(TIME_FORMAT) : "");
            row.createCell(7).setCellValue(schedule.getDurationMinutes() != null ? schedule.getDurationMinutes() : 0);
            row.createCell(8).setCellValue(schedule.getLocationDisplay());
            row.createCell(9).setCellValue(schedule.getStatus() != null ? schedule.getStatus().name() : "");
        }

        // Auto-size columns
        for (int i = 0; i < 10; i++) {
            sheet.autoSizeColumn(i);
        }
    }

    private void createProviderWorkloadSheet(Workbook workbook, Sheet sheet, List<Teacher> providers) {
        CellStyle headerStyle = createHeaderStyle(workbook);

        // Header row
        Row headerRow = sheet.createRow(0);
        String[] headers = {"Provider Name", "Department", "Total Sessions", "Minutes/Week"};
        for (int i = 0; i < headers.length; i++) {
            Cell cell = headerRow.createCell(i);
            cell.setCellValue(headers[i]);
            cell.setCellStyle(headerStyle);
        }

        int rowNum = 1;
        for (Teacher provider : providers) {
            int workload = pullOutSchedulingService.getStaffWorkload(provider.getId());
            long sessionCount = pullOutSchedulingService.countStaffSchedules(provider.getId());

            Row row = sheet.createRow(rowNum++);
            row.createCell(0).setCellValue(provider.getName());
            row.createCell(1).setCellValue(provider.getDepartment() != null ? provider.getDepartment() : "");
            row.createCell(2).setCellValue(sessionCount);
            row.createCell(3).setCellValue(workload);
        }

        // Auto-size columns
        for (int i = 0; i < 4; i++) {
            sheet.autoSizeColumn(i);
        }
    }

    private void createIepsSummarySheet(Workbook workbook, Sheet sheet, List<IEP> ieps) {
        createIepsSheet(workbook, sheet); // Reuse the IEPs sheet creation
    }

    private void createServiceDeliverySheet(Workbook workbook, Sheet sheet, List<IEPService> services) {
        CellStyle headerStyle = createHeaderStyle(workbook);

        // Header row
        Row headerRow = sheet.createRow(0);
        String[] headers = {"Student", "Service Type", "Delivery Model", "Required Min/Week", "Scheduled Min/Week", "Compliance %", "Status", "Provider"};
        for (int i = 0; i < headers.length; i++) {
            Cell cell = headerRow.createCell(i);
            cell.setCellValue(headers[i]);
            cell.setCellStyle(headerStyle);
        }

        int rowNum = 1;
        for (IEPService service : services) {
            Row row = sheet.createRow(rowNum++);
            row.createCell(0).setCellValue(service.getStudent() != null ? service.getStudent().getFullName() : "");
            row.createCell(1).setCellValue(service.getServiceType().getDisplayName());
            row.createCell(2).setCellValue(service.getDeliveryModel().getDisplayName());
            row.createCell(3).setCellValue(service.getMinutesPerWeek());
            row.createCell(4).setCellValue(service.getScheduledMinutesPerWeek());
            row.createCell(5).setCellValue(String.format("%.1f%%", service.getCompliancePercentage()));
            row.createCell(6).setCellValue(service.getStatus().getDisplayName());
            row.createCell(7).setCellValue(service.getAssignedStaff() != null ? service.getAssignedStaff().getName() : "Unassigned");
        }

        // Auto-size columns
        for (int i = 0; i < 8; i++) {
            sheet.autoSizeColumn(i);
        }
    }

    // ==================== Utility Methods ====================

    private CellStyle createHeaderStyle(Workbook workbook) {
        CellStyle style = workbook.createCellStyle();
        Font font = workbook.createFont();
        font.setBold(true);
        style.setFont(font);
        style.setFillForegroundColor(IndexedColors.LIGHT_BLUE.getIndex());
        style.setFillPattern(FillPatternType.SOLID_FOREGROUND);
        style.setBorderBottom(BorderStyle.THIN);
        style.setBorderTop(BorderStyle.THIN);
        style.setBorderLeft(BorderStyle.THIN);
        style.setBorderRight(BorderStyle.THIN);
        return style;
    }

    private CellStyle createDataStyle(Workbook workbook) {
        CellStyle style = workbook.createCellStyle();
        style.setBorderBottom(BorderStyle.THIN);
        style.setBorderTop(BorderStyle.THIN);
        style.setBorderLeft(BorderStyle.THIN);
        style.setBorderRight(BorderStyle.THIN);
        return style;
    }

    private void createDataRow(Sheet sheet, int rowNum, CellStyle labelStyle, CellStyle dataStyle, String label, String value) {
        Row row = sheet.createRow(rowNum);
        Cell labelCell = row.createCell(0);
        labelCell.setCellValue(label);
        labelCell.setCellStyle(labelStyle);

        Cell valueCell = row.createCell(1);
        valueCell.setCellValue(value);
        valueCell.setCellStyle(dataStyle);
    }

    private String escapeCSV(String value) {
        if (value == null) return "";
        if (value.contains(",") || value.contains("\"") || value.contains("\n")) {
            return "\"" + value.replace("\"", "\"\"") + "\"";
        }
        return value;
    }
}
