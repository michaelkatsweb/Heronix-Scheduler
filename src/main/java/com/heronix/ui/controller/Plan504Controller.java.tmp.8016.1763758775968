package com.eduscheduler.ui.controller;

import com.eduscheduler.model.domain.Plan504;
import com.eduscheduler.model.enums.Plan504Status;
import com.eduscheduler.service.Plan504Service;
import javafx.beans.property.SimpleStringProperty;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.fxml.FXML;
import javafx.scene.control.*;
import javafx.scene.input.KeyCode;
import javafx.scene.input.KeyEvent;
import javafx.scene.layout.HBox;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;

import java.time.LocalDate;
import java.time.temporal.ChronoUnit;
import java.util.List;
import java.util.stream.Collectors;

/**
 * 504 Plan Management Controller
 *
 * Controller for managing 504 Plans - viewing, creating, editing, and tracking status.
 *
 * @author EduScheduler Pro Team
 * @version 1.0.0
 * @since Phase 8C - November 21, 2025
 */
@Controller
@Slf4j
public class Plan504Controller {

    @Autowired
    private Plan504Service plan504Service;

    // Search and Filter Controls
    @FXML private TextField searchField;
    @FXML private ComboBox<String> statusFilter;
    @FXML private ComboBox<String> coordinatorFilter;

    // Table and Columns
    @FXML private TableView<Plan504> planTable;
    @FXML private TableColumn<Plan504, String> studentColumn;
    @FXML private TableColumn<Plan504, String> planNumberColumn;
    @FXML private TableColumn<Plan504, String> statusColumn;
    @FXML private TableColumn<Plan504, String> startDateColumn;
    @FXML private TableColumn<Plan504, String> endDateColumn;
    @FXML private TableColumn<Plan504, String> daysRemainingColumn;
    @FXML private TableColumn<Plan504, String> disabilityColumn;
    @FXML private TableColumn<Plan504, String> coordinatorColumn;
    @FXML private TableColumn<Plan504, String> accommodationsColumn;
    @FXML private TableColumn<Plan504, String> actionsColumn;

    // Summary Labels
    @FXML private Label totalPlansLabel;
    @FXML private Label activePlansLabel;
    @FXML private Label draftPlansLabel;
    @FXML private Label expiringPlansLabel;
    @FXML private Label selectionLabel;

    // Context Menu
    @FXML private ContextMenu rowContextMenu;

    // Data
    private ObservableList<Plan504> allPlans = FXCollections.observableArrayList();
    private ObservableList<Plan504> filteredPlans = FXCollections.observableArrayList();

    @FXML
    public void initialize() {
        log.info("Initializing 504 Plan Management Controller");
        setupTable();
        setupFilters();
        loadData();
    }

    private void setupTable() {
        // Configure columns
        studentColumn.setCellValueFactory(data ->
            new SimpleStringProperty(data.getValue().getStudent().getFullName()));

        planNumberColumn.setCellValueFactory(data ->
            new SimpleStringProperty(data.getValue().getPlanNumber() != null ?
                data.getValue().getPlanNumber() : "DRAFT"));

        statusColumn.setCellValueFactory(data ->
            new SimpleStringProperty(data.getValue().getStatus().getDisplayName()));

        startDateColumn.setCellValueFactory(data ->
            new SimpleStringProperty(data.getValue().getStartDate().toString()));

        endDateColumn.setCellValueFactory(data ->
            new SimpleStringProperty(data.getValue().getEndDate().toString()));

        daysRemainingColumn.setCellValueFactory(data -> {
            long days = ChronoUnit.DAYS.between(LocalDate.now(), data.getValue().getEndDate());
            String text = days < 0 ? "EXPIRED" : String.valueOf(days);
            return new SimpleStringProperty(text);
        });

        disabilityColumn.setCellValueFactory(data ->
            new SimpleStringProperty(data.getValue().getDisabilityDescription() != null ?
                data.getValue().getDisabilityDescription() : "N/A"));

        coordinatorColumn.setCellValueFactory(data ->
            new SimpleStringProperty(data.getValue().getCoordinator() != null ?
                data.getValue().getCoordinator() : "N/A"));

        accommodationsColumn.setCellValueFactory(data ->
            new SimpleStringProperty(String.valueOf(data.getValue().getAccommodations().size())));

        // Setup actions column with buttons
        actionsColumn.setCellFactory(col -> new TableCell<>() {
            private final HBox buttonBox = new HBox(5);
            private final Button viewBtn = new Button("View");
            private final Button editBtn = new Button("Edit");

            {
                viewBtn.setOnAction(e -> handleViewDetails(getTableRow().getItem()));
                viewBtn.getStyleClass().add("btn-link");
                editBtn.setOnAction(e -> handleEditPlan(getTableRow().getItem()));
                editBtn.getStyleClass().add("btn-link");
                buttonBox.getChildren().addAll(viewBtn, editBtn);
            }

            @Override
            protected void updateItem(String item, boolean empty) {
                super.updateItem(item, empty);
                setGraphic(empty ? null : buttonBox);
            }
        });

        // Apply row styling based on status
        planTable.setRowFactory(tv -> {
            TableRow<Plan504> row = new TableRow<>();
            row.setOnContextMenuRequested(event -> {
                if (!row.isEmpty()) {
                    planTable.getSelectionModel().select(row.getItem());
                    rowContextMenu.show(row, event.getScreenX(), event.getScreenY());
                }
            });

            row.itemProperty().addListener((obs, oldPlan, newPlan) -> {
                row.getStyleClass().removeAll("status-active", "status-draft", "status-expired", "status-expiring");
                if (newPlan != null) {
                    if (newPlan.getStatus() == Plan504Status.EXPIRED) {
                        row.getStyleClass().add("status-expired");
                    } else if (newPlan.getStatus() == Plan504Status.DRAFT) {
                        row.getStyleClass().add("status-draft");
                    } else if (newPlan.getStatus() == Plan504Status.ACTIVE) {
                        long daysRemaining = ChronoUnit.DAYS.between(LocalDate.now(), newPlan.getEndDate());
                        if (daysRemaining <= 30) {
                            row.getStyleClass().add("status-expiring");
                        } else {
                            row.getStyleClass().add("status-active");
                        }
                    }
                }
            });
            return row;
        });

        // Selection listener
        planTable.getSelectionModel().selectedItemProperty().addListener((obs, oldSelection, newSelection) -> {
            if (newSelection != null) {
                selectionLabel.setText("Selected: " + newSelection.getStudent().getFullName() +
                    " (" + newSelection.getStatus().getDisplayName() + ")");
            } else {
                selectionLabel.setText("No plan selected");
            }
        });

        planTable.setItems(filteredPlans);
    }

    private void setupFilters() {
        // Setup status filter
        statusFilter.getItems().addAll(
            "All Statuses",
            "Active",
            "Draft",
            "Pending Review",
            "Expired"
        );
        statusFilter.setValue("All Statuses");

        // Coordinator filter will be populated dynamically
        coordinatorFilter.getItems().add("All Coordinators");
        coordinatorFilter.setValue("All Coordinators");
    }

    private void loadData() {
        try {
            log.info("Loading 504 Plan data");

            // Load all active plans
            List<Plan504> activePlans = plan504Service.findAllActivePlans();

            // Also load draft and pending review plans
            List<Plan504> draftPlans = plan504Service.findByStatus(Plan504Status.DRAFT);
            List<Plan504> pendingPlans = plan504Service.findByStatus(Plan504Status.PENDING_REVIEW);

            allPlans.clear();
            allPlans.addAll(activePlans);
            allPlans.addAll(draftPlans);
            allPlans.addAll(pendingPlans);

            // Populate coordinator filter
            updateCoordinatorFilter();

            // Apply filters
            applyFilters();

            // Update summary
            updateSummary();

            log.info("Loaded {} 504 Plans", allPlans.size());

        } catch (Exception e) {
            log.error("Error loading 504 Plan data", e);
            showError("Error Loading Data", "Failed to load 504 Plans: " + e.getMessage());
        }
    }

    private void updateCoordinatorFilter() {
        List<String> coordinators = allPlans.stream()
            .map(Plan504::getCoordinator)
            .filter(c -> c != null && !c.isEmpty())
            .distinct()
            .sorted()
            .collect(Collectors.toList());

        coordinatorFilter.getItems().clear();
        coordinatorFilter.getItems().add("All Coordinators");
        coordinatorFilter.getItems().addAll(coordinators);
        coordinatorFilter.setValue("All Coordinators");
    }

    private void applyFilters() {
        String searchText = searchField.getText().toLowerCase();
        String statusValue = statusFilter.getValue();
        String coordinatorValue = coordinatorFilter.getValue();

        filteredPlans.clear();
        filteredPlans.addAll(allPlans.stream()
            .filter(plan -> {
                // Search filter
                if (!searchText.isEmpty()) {
                    String studentName = plan.getStudent().getFullName().toLowerCase();
                    String planNumber = plan.getPlanNumber() != null ? plan.getPlanNumber().toLowerCase() : "";
                    if (!studentName.contains(searchText) && !planNumber.contains(searchText)) {
                        return false;
                    }
                }

                // Status filter
                if (!"All Statuses".equals(statusValue)) {
                    if (!plan.getStatus().getDisplayName().equals(statusValue)) {
                        return false;
                    }
                }

                // Coordinator filter
                if (!"All Coordinators".equals(coordinatorValue)) {
                    if (!coordinatorValue.equals(plan.getCoordinator())) {
                        return false;
                    }
                }

                return true;
            })
            .collect(Collectors.toList()));

        updateSummary();
    }

    private void updateSummary() {
        int total = filteredPlans.size();
        long active = filteredPlans.stream().filter(p -> p.getStatus() == Plan504Status.ACTIVE).count();
        long draft = filteredPlans.stream().filter(p -> p.getStatus() == Plan504Status.DRAFT).count();
        long expiring = filteredPlans.stream()
            .filter(p -> p.getStatus() == Plan504Status.ACTIVE)
            .filter(p -> ChronoUnit.DAYS.between(LocalDate.now(), p.getEndDate()) <= 30)
            .count();

        totalPlansLabel.setText("Total: " + total);
        activePlansLabel.setText("Active: " + active);
        draftPlansLabel.setText("Draft: " + draft);
        expiringPlansLabel.setText("Expiring Soon: " + expiring);
    }

    // Event Handlers

    @FXML
    private void handleRefresh() {
        log.info("Refreshing 504 Plan data");
        loadData();
    }

    @FXML
    private void handleCreatePlan() {
        log.info("Creating new 504 Plan");
        showInfo("Create 504 Plan", "504 Plan creation dialog will be implemented in a future version.");
    }

    @FXML
    private void handleExportReport() {
        log.info("Exporting 504 Plan report");
        showInfo("Export Report", "504 Plan report export will be implemented in a future version.");
    }

    @FXML
    private void handleSearch(KeyEvent event) {
        if (event.getCode() == KeyCode.ENTER || searchField.getText().isEmpty()) {
            applyFilters();
        }
    }

    @FXML
    private void handleFilterChange() {
        applyFilters();
    }

    @FXML
    private void handleClearFilters() {
        searchField.clear();
        statusFilter.setValue("All Statuses");
        coordinatorFilter.setValue("All Coordinators");
        applyFilters();
    }

    // Context Menu Actions

    @FXML
    private void handleViewDetails() {
        Plan504 selected = planTable.getSelectionModel().getSelectedItem();
        handleViewDetails(selected);
    }

    private void handleViewDetails(Plan504 plan) {
        if (plan == null) return;
        log.info("Viewing 504 Plan details: {}", plan.getId());
        showInfo("View Details", "504 Plan detail view will be implemented in a future version.");
    }

    @FXML
    private void handleEditPlan() {
        Plan504 selected = planTable.getSelectionModel().getSelectedItem();
        handleEditPlan(selected);
    }

    private void handleEditPlan(Plan504 plan) {
        if (plan == null) return;
        log.info("Editing 504 Plan: {}", plan.getId());
        showInfo("Edit Plan", "504 Plan editing interface will be implemented in a future version.");
    }

    @FXML
    private void handleManageAccommodations() {
        Plan504 selected = planTable.getSelectionModel().getSelectedItem();
        if (selected == null) return;
        log.info("Managing accommodations for 504 Plan: {}", selected.getId());
        showInfo("Manage Accommodations", "Accommodation management interface will be implemented in a future version.");
    }

    @FXML
    private void handleActivatePlan() {
        Plan504 selected = planTable.getSelectionModel().getSelectedItem();
        if (selected == null) return;

        try {
            log.info("Activating 504 Plan: {}", selected.getId());
            plan504Service.activatePlan(selected.getId());
            showSuccess("Plan Activated", "504 Plan has been activated successfully.");
            loadData();
        } catch (Exception e) {
            log.error("Error activating 504 Plan", e);
            showError("Activation Error", "Failed to activate 504 Plan: " + e.getMessage());
        }
    }

    @FXML
    private void handleMarkForReview() {
        Plan504 selected = planTable.getSelectionModel().getSelectedItem();
        if (selected == null) return;

        try {
            log.info("Marking 504 Plan for review: {}", selected.getId());
            plan504Service.markForReview(selected.getId());
            showSuccess("Marked for Review", "504 Plan has been marked for review.");
            loadData();
        } catch (Exception e) {
            log.error("Error marking 504 Plan for review", e);
            showError("Review Error", "Failed to mark 504 Plan for review: " + e.getMessage());
        }
    }

    @FXML
    private void handleExpirePlan() {
        Plan504 selected = planTable.getSelectionModel().getSelectedItem();
        if (selected == null) return;

        Alert confirmation = new Alert(Alert.AlertType.CONFIRMATION);
        confirmation.setTitle("Expire 504 Plan");
        confirmation.setHeaderText("Confirm Plan Expiration");
        confirmation.setContentText("Are you sure you want to expire this 504 Plan?");

        if (confirmation.showAndWait().orElse(ButtonType.CANCEL) == ButtonType.OK) {
            try {
                log.info("Expiring 504 Plan: {}", selected.getId());
                plan504Service.expirePlan(selected.getId());
                showSuccess("Plan Expired", "504 Plan has been expired.");
                loadData();
            } catch (Exception e) {
                log.error("Error expiring 504 Plan", e);
                showError("Expiration Error", "Failed to expire 504 Plan: " + e.getMessage());
            }
        }
    }

    @FXML
    private void handleGeneratePlanReport() {
        Plan504 selected = planTable.getSelectionModel().getSelectedItem();
        if (selected == null) return;
        log.info("Generating report for 504 Plan: {}", selected.getId());
        showInfo("Generate Report", "504 Plan report generation will be implemented in a future version.");
    }

    @FXML
    private void handlePrintPlan() {
        Plan504 selected = planTable.getSelectionModel().getSelectedItem();
        if (selected == null) return;
        log.info("Printing 504 Plan: {}", selected.getId());
        showInfo("Print Plan", "504 Plan printing will be implemented in a future version.");
    }

    @FXML
    private void handleDeletePlan() {
        Plan504 selected = planTable.getSelectionModel().getSelectedItem();
        if (selected == null) return;

        Alert confirmation = new Alert(Alert.AlertType.CONFIRMATION);
        confirmation.setTitle("Delete 504 Plan");
        confirmation.setHeaderText("Confirm Plan Deletion");
        confirmation.setContentText("Are you sure you want to delete this 504 Plan? This action cannot be undone.\n\n" +
            "Note: Only DRAFT plans can be deleted.");

        if (confirmation.showAndWait().orElse(ButtonType.CANCEL) == ButtonType.OK) {
            try {
                log.info("Deleting 504 Plan: {}", selected.getId());
                plan504Service.deletePlan(selected.getId());
                showSuccess("Plan Deleted", "504 Plan has been deleted.");
                loadData();
            } catch (Exception e) {
                log.error("Error deleting 504 Plan", e);
                showError("Deletion Error", "Failed to delete 504 Plan: " + e.getMessage());
            }
        }
    }

    // Utility Methods

    private void showInfo(String title, String message) {
        Alert alert = new Alert(Alert.AlertType.INFORMATION);
        alert.setTitle(title);
        alert.setHeaderText(null);
        alert.setContentText(message);
        alert.showAndWait();
    }

    private void showSuccess(String title, String message) {
        Alert alert = new Alert(Alert.AlertType.INFORMATION);
        alert.setTitle(title);
        alert.setHeaderText("Success");
        alert.setContentText(message);
        alert.showAndWait();
    }

    private void showError(String title, String message) {
        Alert alert = new Alert(Alert.AlertType.ERROR);
        alert.setTitle(title);
        alert.setHeaderText("Error");
        alert.setContentText(message);
        alert.showAndWait();
    }
}
