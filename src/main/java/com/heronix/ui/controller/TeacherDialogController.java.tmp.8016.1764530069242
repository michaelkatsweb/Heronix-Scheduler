package com.eduscheduler.ui.controller;

import com.eduscheduler.model.domain.Course;
import com.eduscheduler.model.domain.SpecialDutyAssignment;
import com.eduscheduler.model.domain.SubjectCertification;
import com.eduscheduler.model.domain.Teacher;
import com.eduscheduler.model.enums.CertificationType;
import com.eduscheduler.model.enums.DutyType;
import com.eduscheduler.model.enums.PriorityLevel;
import com.eduscheduler.model.enums.USState;
import com.eduscheduler.repository.CourseRepository;
import com.eduscheduler.repository.SpecialDutyAssignmentRepository;
import com.eduscheduler.repository.SubjectCertificationRepository;
import com.eduscheduler.repository.TeacherRepository;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.fxml.FXML;
import javafx.scene.control.*;
import javafx.scene.layout.GridPane;
import javafx.scene.layout.VBox;
import javafx.stage.Stage;
import javafx.util.StringConverter;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.time.LocalDate;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.stream.Collectors;

/**
 * TeacherDialogController - Handles Add/Edit teacher form
 * Location:
 * src/main/java/com/eduscheduler/ui/controller/TeacherDialogController.java
 */
@Component
public class TeacherDialogController {

    @FXML
    private Label dialogTitle;
    @FXML
    private TextField nameField;
    @FXML
    private TextField firstNameField;
    @FXML
    private TextField lastNameField;
    @FXML
    private TextField employeeIdField;
    @FXML
    private TextField emailField;
    @FXML
    private TextField phoneField;
    @FXML
    private ComboBox<String> departmentCombo;
    @FXML
    private Spinner<Integer> maxHoursSpinner;
    @FXML
    private Spinner<Integer> maxConsecutiveSpinner;
    @FXML
    private Spinner<Integer> preferredBreakSpinner;
    @FXML
    private ComboBox<String> priorityCombo;
    @FXML
    private ComboBox<CertificationType> certificationTypeCombo;
    @FXML
    private ComboBox<String> teacherRoleCombo;
    @FXML
    private TextArea manualCertificationsArea;
    @FXML
    private ListView<SubjectCertification> certificationsListView;
    @FXML
    private ListView<Course> assignedCoursesListView;
    @FXML
    private CheckBox activeCheckbox;
    @FXML
    private TextArea notesArea;
    @FXML
    private TextArea specialAssignmentArea;

    @FXML
    private Label nameError;
    @FXML
    private Label employeeIdError;
    @FXML
    private Label emailError;
    @FXML
    private Label departmentError;

    @Autowired
    private TeacherRepository teacherRepository;

    @Autowired
    private SubjectCertificationRepository certificationRepository;

    @Autowired
    private CourseRepository courseRepository;

    @Autowired
    private SpecialDutyAssignmentRepository specialDutyAssignmentRepository;

    @Autowired
    private com.eduscheduler.service.DistrictSettingsService districtSettingsService;

    private Teacher teacher; // For editing existing teacher
    private boolean isEditMode = false;
    private boolean saved = false;
    private javafx.stage.Stage dialogStage;

    private ObservableList<SubjectCertification> certifications = FXCollections.observableArrayList();
    private ObservableList<Course> assignedCourses = FXCollections.observableArrayList();

    @FXML
    public void initialize() {
        // Setup department dropdown
        departmentCombo.getItems().addAll(
                "Mathematics",
                "Science",
                "English",
                "History",
                "Computer Science",
                "Arts",
                "Physical Education",
                "Foreign Languages",
                "Special Education",
                "Music",
                "Other");

        // Setup priority dropdown - use actual PriorityLevel enum values
        priorityCombo.getItems().addAll(
                "Q1_URGENT_IMPORTANT",
                "Q2_IMPORTANT_NOT_URGENT",
                "Q3_URGENT_NOT_IMPORTANT",
                "Q4_NEITHER",
                "CRITICAL",
                "HIGH",
                "NORMAL",
                "LOW");
        priorityCombo.getSelectionModel().select("NORMAL");

        // Setup spinners with value factories
        SpinnerValueFactory<Integer> hoursFactory = new SpinnerValueFactory.IntegerSpinnerValueFactory(10, 50, 40, 5);
        maxHoursSpinner.setValueFactory(hoursFactory);

        SpinnerValueFactory<Integer> consecutiveFactory = new SpinnerValueFactory.IntegerSpinnerValueFactory(1, 10, 8,
                1);
        maxConsecutiveSpinner.setValueFactory(consecutiveFactory);

        SpinnerValueFactory<Integer> breakFactory = new SpinnerValueFactory.IntegerSpinnerValueFactory(0, 60, 30, 5);
        preferredBreakSpinner.setValueFactory(breakFactory);

        // Setup certification type dropdown
        certificationTypeCombo.setItems(FXCollections.observableArrayList(CertificationType.values()));
        certificationTypeCombo.setConverter(new StringConverter<CertificationType>() {
            @Override
            public String toString(CertificationType type) {
                return type != null ? type.getDisplayName() : "";
            }
            @Override
            public CertificationType fromString(String string) {
                return null;
            }
        });
        certificationTypeCombo.getSelectionModel().select(CertificationType.CERTIFIED);

        // Setup teacher role dropdown
        teacherRoleCombo.getItems().addAll(
                "TEACHER",
                "CO_TEACHER",
                "PARAPROFESSIONAL",
                "SUBSTITUTE");
        teacherRoleCombo.getSelectionModel().select("TEACHER");

        // Setup certifications ListView
        certificationsListView.setItems(certifications);
        certificationsListView.setCellFactory(lv -> new ListCell<SubjectCertification>() {
            @Override
            protected void updateItem(SubjectCertification cert, boolean empty) {
                super.updateItem(cert, empty);
                if (empty || cert == null) {
                    setText(null);
                    setGraphic(null);
                } else {
                    setText(cert.getDisplayString() + " - " + cert.getStatusString());
                    if (cert.isExpired()) {
                        setStyle("-fx-text-fill: red;");
                    } else if (cert.isExpiringSoon()) {
                        setStyle("-fx-text-fill: orange;");
                    } else {
                        setStyle("-fx-text-fill: green;");
                    }
                }
            }
        });

        // Add context menu to ListView for deleting certifications
        certificationsListView.setContextMenu(createCertificationContextMenu());

        // Setup assigned courses ListView
        assignedCoursesListView.setItems(assignedCourses);
        assignedCoursesListView.setCellFactory(lv -> new ListCell<Course>() {
            @Override
            protected void updateItem(Course course, boolean empty) {
                super.updateItem(course, empty);
                if (empty || course == null) {
                    setText(null);
                    setGraphic(null);
                } else {
                    setText(course.getCourseCode() + " - " + course.getCourseName() + " (" + course.getSubject() + ")");
                    setStyle("-fx-text-fill: #2c3e50;");
                }
            }
        });

        // Add context menu to ListView for removing course assignments
        assignedCoursesListView.setContextMenu(createCourseContextMenu());

        // Setup email auto-generation listeners
        setupEmailAutoGeneration();

        // Setup ID auto-generation (will be called when dialog opens in add mode)
    }

    /**
     * Setup email auto-generation based on first and last name
     */
    private void setupEmailAutoGeneration() {
        if (districtSettingsService == null) {
            return; // Service not available
        }

        // Add listeners to first and last name fields
        javafx.beans.value.ChangeListener<String> nameChangeListener = (obs, oldVal, newVal) -> {
            // Only auto-generate if both fields have values and email field is empty or was auto-generated
            String firstName = firstNameField.getText();
            String lastName = lastNameField.getText();

            if (firstName != null && !firstName.trim().isEmpty() &&
                lastName != null && !lastName.trim().isEmpty()) {

                // Only auto-fill if email is empty or in edit mode
                if (!isEditMode || emailField.getText() == null || emailField.getText().trim().isEmpty()) {
                    try {
                        String generatedEmail = districtSettingsService.generateTeacherEmail(firstName, lastName);
                        if (generatedEmail != null && !generatedEmail.isEmpty()) {
                            emailField.setText(generatedEmail);
                            emailField.setStyle("-fx-text-fill: #2196F3;"); // Blue text to indicate auto-generated
                        }
                    } catch (Exception e) {
                        // Silently ignore if generation fails
                        System.err.println("Failed to generate email: " + e.getMessage());
                    }
                }
            }
        };

        firstNameField.textProperty().addListener(nameChangeListener);
        lastNameField.textProperty().addListener(nameChangeListener);

        // Reset text color when user manually edits email
        emailField.textProperty().addListener((obs, oldVal, newVal) -> {
            if (newVal != null && !newVal.equals(oldVal)) {
                // User manually edited - change to normal color
                emailField.setStyle("");
            }
        });
    }

    /**
     * Auto-generate employee ID for new teacher
     */
    private void autoGenerateEmployeeId() {
        if (districtSettingsService == null || isEditMode) {
            return; // Don't auto-generate in edit mode
        }

        try {
            String generatedId = districtSettingsService.generateNextTeacherId();
            if (generatedId != null && !generatedId.isEmpty()) {
                employeeIdField.setText(generatedId);
                employeeIdField.setStyle("-fx-text-fill: #2196F3;"); // Blue text to indicate auto-generated
            }
        } catch (Exception e) {
            // Silently ignore if generation fails
            System.err.println("Failed to generate employee ID: " + e.getMessage());
        }
    }

    private ContextMenu createCertificationContextMenu() {
        ContextMenu menu = new ContextMenu();
        MenuItem deleteItem = new MenuItem("Remove Certification");
        deleteItem.setOnAction(e -> {
            SubjectCertification selected = certificationsListView.getSelectionModel().getSelectedItem();
            if (selected != null) {
                certifications.remove(selected);
            }
        });
        menu.getItems().add(deleteItem);
        return menu;
    }

    private ContextMenu createCourseContextMenu() {
        ContextMenu menu = new ContextMenu();
        MenuItem removeItem = new MenuItem("Remove Course Assignment");
        removeItem.setOnAction(e -> {
            Course selected = assignedCoursesListView.getSelectionModel().getSelectedItem();
            if (selected != null) {
                // IMPORTANT: If in edit mode, remove from database immediately
                if (isEditMode && teacher != null) {
                    Alert confirm = new Alert(Alert.AlertType.CONFIRMATION);
                    confirm.setTitle("Remove Course Assignment");
                    confirm.setHeaderText("Remove " + selected.getCourseName() + "?");
                    confirm.setContentText("This will immediately unassign this course from " + teacher.getName());

                    if (confirm.showAndWait().orElse(ButtonType.CANCEL) == ButtonType.OK) {
                        try {
                            // Remove from database
                            selected.setTeacher(null);
                            teacher.getCourses().remove(selected);
                            courseRepository.save(selected);
                            teacherRepository.save(teacher);

                            // Remove from UI
                            assignedCourses.remove(selected);

                            showSuccess("Course removed successfully");
                        } catch (Exception ex) {
                            showError("Error removing course: " + ex.getMessage());
                            ex.printStackTrace();
                        }
                    }
                } else {
                    // In add mode, just remove from UI list
                    assignedCourses.remove(selected);
                }
            }
        });
        menu.getItems().add(removeItem);
        return menu;
    }

    /**
     * Prepare form for adding a new teacher (call before showing dialog)
     */
    public void prepareForNew() {
        this.teacher = null;
        this.isEditMode = false;
        dialogTitle.setText("Add New Teacher");

        // Clear all form fields
        clearAllFields();

        // Generate next employee ID
        String nextEmployeeId = generateNextEmployeeId();
        employeeIdField.setText(nextEmployeeId);
        employeeIdField.setEditable(true);
        employeeIdField.setStyle("");

        // Set defaults
        activeCheckbox.setSelected(true);
        priorityCombo.setValue("NORMAL");
        teacherRoleCombo.setValue("TEACHER");
        certificationTypeCombo.getSelectionModel().select(CertificationType.CERTIFIED);

        // Focus on first name field
        javafx.application.Platform.runLater(() -> firstNameField.requestFocus());
    }

    /**
     * Clear all form fields
     */
    private void clearAllFields() {
        // Clear text fields
        nameField.clear();
        firstNameField.clear();
        lastNameField.clear();
        employeeIdField.clear();
        emailField.clear();
        phoneField.clear();

        // Clear text areas
        manualCertificationsArea.clear();
        notesArea.clear();
        specialAssignmentArea.clear();

        // Reset combo boxes to defaults
        departmentCombo.setValue(null);
        priorityCombo.setValue("NORMAL");
        certificationTypeCombo.getSelectionModel().select(CertificationType.CERTIFIED);
        teacherRoleCombo.setValue("TEACHER");

        // Reset spinners to defaults
        maxHoursSpinner.getValueFactory().setValue(40);
        maxConsecutiveSpinner.getValueFactory().setValue(8);
        preferredBreakSpinner.getValueFactory().setValue(30);

        // Clear observable lists
        certifications.clear();
        assignedCourses.clear();

        // Reset checkbox
        activeCheckbox.setSelected(true);

        // Clear error labels
        if (nameError != null) nameError.setText("");
        if (employeeIdError != null) employeeIdError.setText("");
        if (emailError != null) emailError.setText("");
        if (departmentError != null) departmentError.setText("");
    }

    /**
     * Generate next employee ID (T001, T002, T003, etc.)
     */
    private String generateNextEmployeeId() {
        try {
            List<Teacher> allTeachers = teacherRepository.findAll();

            if (allTeachers == null || allTeachers.isEmpty()) {
                return "T001";
            }

            // Find highest employee number
            int maxNumber = allTeachers.stream()
                .map(Teacher::getEmployeeId)
                .filter(id -> id != null && id.matches("T\\d+"))
                .map(id -> Integer.parseInt(id.substring(1)))
                .max(Integer::compareTo)
                .orElse(0);

            return String.format("T%03d", maxNumber + 1);
        } catch (Exception e) {
            // If error, return default
            return "T001";
        }
    }

    /**
     * Set teacher for editing (call before showing dialog)
     */
    public void setTeacher(Teacher teacher) {
        this.teacher = teacher;
        this.isEditMode = true;
        dialogTitle.setText("Edit Teacher");

        // Populate fields
        nameField.setText(teacher.getName());
        firstNameField.setText(teacher.getFirstName());
        lastNameField.setText(teacher.getLastName());
        employeeIdField.setText(teacher.getEmployeeId());
        emailField.setText(teacher.getEmail());
        phoneField.setText(teacher.getPhoneNumber());
        departmentCombo.setValue(teacher.getDepartment());
        maxHoursSpinner.getValueFactory().setValue(teacher.getMaxHoursPerWeek());
        maxConsecutiveSpinner.getValueFactory().setValue(teacher.getMaxConsecutiveHours());

        // Set preferred break minutes
        if (teacher.getPreferredBreakMinutes() != null) {
            preferredBreakSpinner.getValueFactory().setValue(teacher.getPreferredBreakMinutes());
        }

        if (teacher.getPriorityLevel() != null) {
            priorityCombo.setValue(teacher.getPriorityLevel().name());
        }

        activeCheckbox.setSelected(teacher.getActive());
        notesArea.setText(teacher.getNotes());
        specialAssignmentArea.setText(teacher.getSpecialAssignment());

        // Set certification type
        if (teacher.getCertificationType() != null) {
            certificationTypeCombo.setValue(teacher.getCertificationType());
        }

        // Set teacher role
        if (teacher.getTeacherRole() != null) {
            teacherRoleCombo.setValue(teacher.getTeacherRole());
        }

        // Load manual certifications (simple text list)
        if (teacher.getCertifications() != null && !teacher.getCertifications().isEmpty()) {
            manualCertificationsArea.setText(String.join("\n", teacher.getCertifications()));
        }

        // Load certifications
        certifications.clear();
        if (teacher.getSubjectCertifications() != null) {
            certifications.addAll(teacher.getSubjectCertifications());
        }

        // Load assigned courses
        assignedCourses.clear();
        if (teacher.getCourses() != null) {
            assignedCourses.addAll(teacher.getCourses());
        }

        // Make employee ID read-only when editing
        employeeIdField.setEditable(false);
        employeeIdField.setStyle("-fx-background-color: #f0f0f0;");
    }

    @FXML
    private void handleSave() {
        if (validateForm()) {
            try {
                if (isEditMode) {
                    // Update existing teacher
                    updateTeacherFromForm(teacher);
                    teacherRepository.save(teacher);
                    showSuccess("Teacher updated successfully!");
                } else {
                    // Create new teacher
                    Teacher newTeacher = new Teacher();
                    updateTeacherFromForm(newTeacher);
                    teacherRepository.save(newTeacher);
                    showSuccess("Teacher created successfully!");
                }

                saved = true;
                closeDialog();

            } catch (Exception e) {
                showError("Error saving teacher: " + e.getMessage());
                e.printStackTrace();
            }
        }
    }

    private void updateTeacherFromForm(Teacher teacher) {
        // Set name (required field)
        if (nameField.getText() != null && !nameField.getText().trim().isEmpty()) {
            teacher.setName(nameField.getText().trim());
        }

        // Set first name and last name
        if (firstNameField.getText() != null && !firstNameField.getText().trim().isEmpty()) {
            teacher.setFirstName(firstNameField.getText().trim());
        }
        if (lastNameField.getText() != null && !lastNameField.getText().trim().isEmpty()) {
            teacher.setLastName(lastNameField.getText().trim());
        }

        // Set employee ID (with null check)
        if (employeeIdField.getText() != null) {
            teacher.setEmployeeId(employeeIdField.getText().trim());
        }

        // Set email (with null check)
        if (emailField.getText() != null) {
            teacher.setEmail(emailField.getText().trim());
        }

        // Set phone number (with null check)
        if (phoneField.getText() != null) {
            teacher.setPhoneNumber(phoneField.getText().trim());
        }
        teacher.setDepartment(departmentCombo.getValue());
        teacher.setMaxHoursPerWeek(maxHoursSpinner.getValue());
        teacher.setMaxConsecutiveHours(maxConsecutiveSpinner.getValue());
        teacher.setPreferredBreakMinutes(preferredBreakSpinner.getValue());

        String priorityStr = priorityCombo.getValue();
        if (priorityStr != null && !priorityStr.isEmpty()) {
            teacher.setPriorityLevel(PriorityLevel.valueOf(priorityStr));
        }

        // Set certification type
        if (certificationTypeCombo.getValue() != null) {
            teacher.setCertificationType(certificationTypeCombo.getValue());
        }

        // Set teacher role
        if (teacherRoleCombo.getValue() != null) {
            teacher.setTeacherRole(teacherRoleCombo.getValue());
        }

        // Parse and save manual certifications (simple text list)
        teacher.getCertifications().clear();
        String manualCertsText = manualCertificationsArea.getText();
        if (manualCertsText != null && !manualCertsText.trim().isEmpty()) {
            // Split by newlines or commas
            String[] lines = manualCertsText.split("[\\n,]");
            for (String line : lines) {
                String cert = line.trim();
                if (!cert.isEmpty()) {
                    teacher.getCertifications().add(cert);
                }
            }
        }

        // Update certifications
        teacher.getSubjectCertifications().clear();
        for (SubjectCertification cert : certifications) {
            cert.setTeacher(teacher);
            teacher.getSubjectCertifications().add(cert);
        }

        // Update course assignments
        teacher.getCourses().clear();
        for (Course course : assignedCourses) {
            course.setTeacher(teacher);
            teacher.getCourses().add(course);
        }

        teacher.setActive(activeCheckbox.isSelected());
        teacher.setNotes(notesArea.getText());
        teacher.setSpecialAssignment(specialAssignmentArea.getText());

        // SYNC: If special assignment text is provided, create/update SpecialDutyAssignment
        syncSpecialAssignmentToRoster(teacher);
    }

    /**
     * Synchronize the Special Assignment text field to the Special Duty Roster
     * Creates a SpecialDutyAssignment entry so it appears in the roster
     */
    private void syncSpecialAssignmentToRoster(Teacher teacher) {
        String specialAssignmentText = specialAssignmentArea.getText();

        if (specialAssignmentText != null && !specialAssignmentText.trim().isEmpty()) {
            // Check if teacher already has a special duty assignment for this description
            boolean exists = teacher.getSpecialDutyAssignments().stream()
                .anyMatch(duty -> duty.getCustomDutyName() != null &&
                                 duty.getCustomDutyName().equals(specialAssignmentText.trim()));

            if (!exists) {
                // Create new SpecialDutyAssignment
                SpecialDutyAssignment dutyAssignment = new SpecialDutyAssignment();
                dutyAssignment.setTeacher(teacher);
                dutyAssignment.setDutyType(DutyType.CUSTOM);
                dutyAssignment.setCustomDutyName(specialAssignmentText.trim());
                dutyAssignment.setStaffType("TEACHER");
                dutyAssignment.setIsRecurring(false); // One-time assignment by default
                dutyAssignment.setIsMandatory(false); // Optional by default
                dutyAssignment.setActive(true);
                dutyAssignment.setConfirmedByStaff(false);
                dutyAssignment.setPriority(3); // Low priority by default

                // Add notes indicating it was created from teacher profile
                dutyAssignment.setNotes("Created from teacher profile Special Assignment field");

                // Add to teacher's special duty assignments
                teacher.getSpecialDutyAssignments().add(dutyAssignment);

                // Save to database
                try {
                    specialDutyAssignmentRepository.save(dutyAssignment);
                } catch (Exception e) {
                    System.err.println("Error saving special duty assignment: " + e.getMessage());
                    // Log but don't fail the teacher save
                }
            }
        }
    }

    private boolean validateForm() {
        boolean valid = true;

        // Reset error messages
        hideError(nameError);
        hideError(employeeIdError);
        hideError(emailError);
        hideError(departmentError);

        // Validate name
        if (nameField.getText() == null || nameField.getText().trim().isEmpty()) {
            showFieldError(nameError, "Name is required");
            valid = false;
        }

        // Validate employee ID
        String empId = employeeIdField.getText();
        if (empId == null || empId.trim().isEmpty()) {
            showFieldError(employeeIdError, "Employee ID is required");
            valid = false;
        } else if (!isEditMode) {
            // Check for duplicate employee ID (only when creating new)
            if (teacherRepository.findByEmployeeId(empId.trim()).isPresent()) {
                showFieldError(employeeIdError, "Employee ID already exists");
                valid = false;
            }
        }

        // Validate email
        String email = emailField.getText();
        if (email == null || email.trim().isEmpty()) {
            showFieldError(emailError, "Email is required");
            valid = false;
        } else if (!isValidEmail(email)) {
            showFieldError(emailError, "Invalid email format");
            valid = false;
        } else if (!isEditMode || !email.equals(teacher.getEmail())) {
            // Check for duplicate email (only when creating new or changing email)
            if (teacherRepository.findByEmail(email.trim()).isPresent()) {
                showFieldError(emailError, "Email already exists");
                valid = false;
            }
        }

        // Validate department
        if (departmentCombo.getValue() == null || departmentCombo.getValue().isEmpty()) {
            showFieldError(departmentError, "Department is required");
            valid = false;
        }

        return valid;
    }

    private boolean isValidEmail(String email) {
        String emailRegex = "^[A-Za-z0-9+_.-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$";
        return email.matches(emailRegex);
    }

    private void showFieldError(Label errorLabel, String message) {
        errorLabel.setText(message);
        errorLabel.setVisible(true);
        errorLabel.setManaged(true);
    }

    private void hideError(Label errorLabel) {
        errorLabel.setVisible(false);
        errorLabel.setManaged(false);
    }

    @FXML
    private void handleCancel() {
        if (hasUnsavedChanges()) {
            Alert alert = new Alert(Alert.AlertType.CONFIRMATION);
            alert.setTitle("Unsaved Changes");
            alert.setHeaderText("You have unsaved changes");
            alert.setContentText("Are you sure you want to cancel?");

            if (alert.showAndWait().orElse(ButtonType.CANCEL) == ButtonType.OK) {
                closeDialog();
            }
        } else {
            closeDialog();
        }
    }

    private boolean hasUnsavedChanges() {
        // Simple check - if any field has content (with null safety)
        return (nameField.getText() != null && !nameField.getText().isEmpty()) ||
                (employeeIdField.getText() != null && !employeeIdField.getText().isEmpty()) ||
                (emailField.getText() != null && !emailField.getText().isEmpty());
    }

    private void closeDialog() {
        if (dialogStage != null) {
            dialogStage.close();
        } else {
            Stage stage = (Stage) nameField.getScene().getWindow();
            stage.close();
        }
    }

    /**
     * Set the dialog stage
     */
    public void setDialogStage(Stage dialogStage) {
        this.dialogStage = dialogStage;

        // Auto-generate employee ID for new teacher (not in edit mode)
        if (!isEditMode) {
            autoGenerateEmployeeId();
        }
    }

    /**
     * Check if teacher was saved
     */
    public boolean isSaved() {
        return saved;
    }

    private void showSuccess(String message) {
        Alert alert = new Alert(Alert.AlertType.INFORMATION);
        alert.setTitle("Success");
        alert.setHeaderText(null);
        alert.setContentText(message);
        alert.showAndWait();
    }

    private void showError(String message) {
        Alert alert = new Alert(Alert.AlertType.ERROR);
        alert.setTitle("Error");
        alert.setHeaderText("Failed to save teacher");
        alert.setContentText(message);
        alert.showAndWait();
    }

    public boolean wasSaved() {
        return saved;
    }

    /**
     * Handle adding a new certification
     */
    @FXML
    private void handleAddCertification() {
        // Create a dialog for adding certification
        Dialog<SubjectCertification> dialog = new Dialog<>();
        dialog.setTitle("Add Subject Certification");
        dialog.setHeaderText("Enter FLDOE Certification Details");

        // Set button types
        ButtonType addButtonType = new ButtonType("Add", ButtonBar.ButtonData.OK_DONE);
        dialog.getDialogPane().getButtonTypes().addAll(addButtonType, ButtonType.CANCEL);

        // Create form fields
        GridPane grid = new GridPane();
        grid.setHgap(10);
        grid.setVgap(10);
        grid.setPadding(new javafx.geometry.Insets(20, 150, 10, 10));

        // State selection dropdown
        ComboBox<USState> stateCombo = new ComboBox<>();
        stateCombo.setItems(FXCollections.observableArrayList(USState.values()));
        stateCombo.setConverter(new StringConverter<USState>() {
            @Override
            public String toString(USState state) {
                return state != null ? state.getFullDisplayName() : "";
            }
            @Override
            public USState fromString(String string) {
                return null;
            }
        });
        stateCombo.getSelectionModel().select(USState.FL); // Default to Florida

        ComboBox<String> subjectCombo = new ComboBox<>();
        subjectCombo.getItems().addAll(
                "Mathematics",
                "Science",
                "Biology",
                "Chemistry",
                "Physics",
                "English/Language Arts",
                "Reading",
                "History",
                "Social Studies",
                "Computer Science",
                "Technology",
                "Physical Education",
                "Health",
                "Music",
                "Art",
                "Foreign Languages",
                "Spanish",
                "French",
                "Special Education (ESE/SPED)",
                "ESOL/ELL",
                "Gifted Education",
                "Career and Technical Education (CTE)"
        );
        subjectCombo.setEditable(true);

        ComboBox<String> gradeRangeCombo = new ComboBox<>();
        gradeRangeCombo.getItems().addAll(
                "K-6",      // Elementary (common)
                "K-8",      // Some states
                "K-12",     // All grades
                "6-12",     // Secondary (common)
                "7-12",     // Texas, some states
                "9-12",     // High School only
                "PreK-3",   // Early childhood
                "4-8",      // Middle grades
                "5-9"       // Some states
        );
        gradeRangeCombo.setEditable(true);

        TextField certNumberField = new TextField();
        certNumberField.setPromptText("e.g., 1234567");

        ComboBox<CertificationType> certTypeCombo = new ComboBox<>();
        certTypeCombo.setItems(FXCollections.observableArrayList(CertificationType.values()));
        certTypeCombo.setConverter(new StringConverter<CertificationType>() {
            @Override
            public String toString(CertificationType type) {
                return type != null ? type.getDisplayName() : "";
            }
            @Override
            public CertificationType fromString(String string) {
                return null;
            }
        });
        certTypeCombo.getSelectionModel().select(CertificationType.CERTIFIED);

        DatePicker issueDatePicker = new DatePicker(LocalDate.now());
        DatePicker expirationDatePicker = new DatePicker(LocalDate.now().plusYears(5));

        TextField specializationsField = new TextField();
        specializationsField.setPromptText("e.g., AP Calculus, Gifted, ESE");

        // Add info label about state-specific naming
        Label infoLabel = new Label("Note: Each state has different certification names and grade ranges.");
        infoLabel.setStyle("-fx-font-size: 10px; -fx-text-fill: #666; -fx-wrap-text: true;");
        infoLabel.setMaxWidth(400);

        grid.add(new Label("Issuing State: *"), 0, 0);
        grid.add(stateCombo, 1, 0);
        grid.add(new Label("Subject: *"), 0, 1);
        grid.add(subjectCombo, 1, 1);
        grid.add(new Label("Grade Range: *"), 0, 2);
        grid.add(gradeRangeCombo, 1, 2);
        grid.add(new Label("Cert Number:"), 0, 3);
        grid.add(certNumberField, 1, 3);
        grid.add(new Label("Cert Type: *"), 0, 4);
        grid.add(certTypeCombo, 1, 4);
        grid.add(new Label("Issue Date:"), 0, 5);
        grid.add(issueDatePicker, 1, 5);
        grid.add(new Label("Expiration:"), 0, 6);
        grid.add(expirationDatePicker, 1, 6);
        grid.add(new Label("Specializations:"), 0, 7);
        grid.add(specializationsField, 1, 7);
        grid.add(infoLabel, 0, 8, 2, 1);

        dialog.getDialogPane().setContent(grid);

        // Convert result when Add button clicked
        dialog.setResultConverter(dialogButton -> {
            if (dialogButton == addButtonType) {
                if (subjectCombo.getValue() == null || subjectCombo.getValue().isEmpty()) {
                    showError("Subject is required");
                    return null;
                }
                if (gradeRangeCombo.getValue() == null || gradeRangeCombo.getValue().isEmpty()) {
                    showError("Grade range is required");
                    return null;
                }

                SubjectCertification cert = new SubjectCertification();
                cert.setIssuingState(stateCombo.getValue());
                cert.setSubject(subjectCombo.getValue());
                cert.setGradeRange(gradeRangeCombo.getValue());
                cert.setCertificationNumber(certNumberField.getText());
                cert.setCertificationType(certTypeCombo.getValue());
                cert.setIssueDate(issueDatePicker.getValue());
                cert.setExpirationDate(expirationDatePicker.getValue());
                cert.setSpecializations(specializationsField.getText());
                // Issuing agency will be auto-populated from state via @PrePersist
                cert.setActive(true);

                return cert;
            }
            return null;
        });

        // Show dialog and add certification if valid
        dialog.showAndWait().ifPresent(cert -> {
            if (cert != null) {
                certifications.add(cert);
            }
        });
    }

    /**
     * Handle assigning a course to the teacher
     */
    @FXML
    private void handleAssignCourse() {
        // Get all available courses from database
        List<Course> allCourses = courseRepository.findByActiveTrue();

        if (allCourses == null || allCourses.isEmpty()) {
            showError("No active courses found in the database. Please add courses first.");
            return;
        }

        // Filter out courses already assigned
        List<Course> availableCourses = allCourses.stream()
                .filter(course -> !assignedCourses.contains(course))
                .collect(java.util.stream.Collectors.toList());

        if (availableCourses.isEmpty()) {
            showError("All courses have already been assigned to this teacher.");
            return;
        }

        // Create dialog with list of courses
        Dialog<List<Course>> dialog = new Dialog<>();
        dialog.setTitle("Assign Courses to Teacher");
        dialog.setHeaderText("Select courses this teacher is qualified to teach");

        ButtonType assignButtonType = new ButtonType("Assign Selected", ButtonBar.ButtonData.OK_DONE);
        dialog.getDialogPane().getButtonTypes().addAll(assignButtonType, ButtonType.CANCEL);

        // Create a ListView with checkboxes for multi-select
        VBox vbox = new VBox(10);
        vbox.setPadding(new javafx.geometry.Insets(20));

        Label instructionLabel = new Label("Select one or more courses:");
        instructionLabel.setStyle("-fx-font-weight: bold;");

        TextField searchField = new TextField();
        searchField.setPromptText("Search courses by code, name, or subject...");
        searchField.setPrefWidth(500);

        ListView<Course> courseListView = new ListView<>();
        courseListView.setPrefHeight(400);
        courseListView.setPrefWidth(500);
        courseListView.getSelectionModel().setSelectionMode(SelectionMode.MULTIPLE);

        ObservableList<Course> coursesObservableList = FXCollections.observableArrayList(availableCourses);
        courseListView.setItems(coursesObservableList);

        // Custom cell factory to show course details
        courseListView.setCellFactory(lv -> new ListCell<Course>() {
            @Override
            protected void updateItem(Course course, boolean empty) {
                super.updateItem(course, empty);
                if (empty || course == null) {
                    setText(null);
                } else {
                    setText(String.format("%s - %s (%s) - Level: %s",
                        course.getCourseCode(),
                        course.getCourseName(),
                        course.getSubject() != null ? course.getSubject() : "N/A",
                        course.getLevel() != null ? course.getLevel().name() : "N/A"));
                }
            }
        });

        // Add search functionality
        searchField.textProperty().addListener((obs, oldVal, newVal) -> {
            if (newVal == null || newVal.isEmpty()) {
                courseListView.setItems(coursesObservableList);
            } else {
                String searchLower = newVal.toLowerCase();
                ObservableList<Course> filtered = coursesObservableList.filtered(course ->
                    course.getCourseCode().toLowerCase().contains(searchLower) ||
                    course.getCourseName().toLowerCase().contains(searchLower) ||
                    (course.getSubject() != null && course.getSubject().toLowerCase().contains(searchLower))
                );
                courseListView.setItems(filtered);
            }
        });

        Label helpLabel = new Label("Tip: Hold Ctrl (or Cmd on Mac) to select multiple courses");
        helpLabel.setStyle("-fx-font-size: 11px; -fx-text-fill: #666;");

        vbox.getChildren().addAll(instructionLabel, searchField, courseListView, helpLabel);
        dialog.getDialogPane().setContent(vbox);

        // Convert result when Assign button clicked
        dialog.setResultConverter(dialogButton -> {
            if (dialogButton == assignButtonType) {
                return courseListView.getSelectionModel().getSelectedItems().stream()
                    .collect(java.util.stream.Collectors.toList());
            }
            return null;
        });

        // Show dialog and add selected courses
        dialog.showAndWait().ifPresent(selectedCourses -> {
            if (selectedCourses != null && !selectedCourses.isEmpty()) {
                // IMPORTANT: In edit mode, save assignments immediately to database
                // This ensures they persist if dialog is closed and reopened
                if (isEditMode && teacher != null) {
                    try {
                        // Add courses to teacher and save
                        // FIX: Reload course from database to avoid "detached entity" error
                        for (Course course : selectedCourses) {
                            // Reload the course to attach it to current Hibernate session
                            Course managedCourse = courseRepository.findById(course.getId())
                                .orElseThrow(() -> new RuntimeException("Course not found: " + course.getId()));

                            managedCourse.setTeacher(teacher);
                            teacher.getCourses().add(managedCourse);
                            courseRepository.save(managedCourse);
                        }
                        teacherRepository.save(teacher);

                        // Update UI list (use managed courses)
                        // Reload teacher's courses to get managed entities
                        Teacher refreshedTeacher = teacherRepository.findById(teacher.getId())
                            .orElseThrow(() -> new RuntimeException("Teacher not found"));
                        assignedCourses.clear();
                        assignedCourses.addAll(refreshedTeacher.getCourses());

                        showSuccess(String.format("Successfully assigned %d course(s) to %s",
                            selectedCourses.size(), teacher.getName()));
                    } catch (Exception e) {
                        showError("Error assigning courses: " + e.getMessage());
                        e.printStackTrace();
                    }
                } else {
                    // In add mode, just update UI list (will be saved when teacher is saved)
                    assignedCourses.addAll(selectedCourses);
                }
            }
        });
    }
}