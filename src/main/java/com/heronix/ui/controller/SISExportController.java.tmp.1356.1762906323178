package com.eduscheduler.ui.controller;

import com.eduscheduler.dto.SISExportResult;
import com.eduscheduler.repository.CourseSectionRepository;
import com.eduscheduler.repository.StudentRepository;
import com.eduscheduler.repository.TeacherRepository;
import com.eduscheduler.service.NotificationService;
import com.eduscheduler.service.SISExportService;
import javafx.application.Platform;
import javafx.concurrent.Task;
import javafx.fxml.FXML;
import javafx.scene.control.*;
import javafx.scene.layout.VBox;
import javafx.stage.DirectoryChooser;
import javafx.stage.FileChooser;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.awt.Desktop;
import java.io.File;
import java.io.IOException;
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.List;

/**
 * Controller for SIS Export functionality
 * Handles exporting schedules to various Student Information Systems
 *
 * Location: src/main/java/com/eduscheduler/ui/controller/SISExportController.java
 */
@Component
public class SISExportController {

    @Autowired
    private SISExportService sisExportService;

    @Autowired
    private CourseSectionRepository courseSectionRepository;

    @Autowired
    private StudentRepository studentRepository;

    @Autowired
    private TeacherRepository teacherRepository;

    @Autowired(required = false)
    private NotificationService notificationService;

    // ========== FXML Components ==========

    // Export Type
    @FXML private RadioButton masterScheduleRadio;
    @FXML private RadioButton studentSchedulesRadio;
    @FXML private RadioButton teacherSchedulesRadio;
    @FXML private RadioButton courseSectionsRadio;
    @FXML private RadioButton enrollmentsRadio;

    // Format
    @FXML private RadioButton powerSchoolRadio;
    @FXML private RadioButton skywardRadio;
    @FXML private RadioButton infiniteCampusRadio;
    @FXML private RadioButton genericCSVRadio;
    @FXML private RadioButton excelRadio;

    // Options
    @FXML private CheckBox validateDataCheckbox;
    @FXML private CheckBox openAfterExportCheckbox;
    @FXML private CheckBox includeHeaderCheckbox;
    @FXML private TextField outputPathField;

    // Preview & Status
    @FXML private TextArea previewTextArea;
    @FXML private Label statusLabel;
    @FXML private ProgressBar exportProgressBar;
    @FXML private VBox validationResultsContainer;

    // History & Stats
    @FXML private ListView<String> exportHistoryList;
    @FXML private Label totalSectionsLabel;
    @FXML private Label totalStudentsLabel;
    @FXML private Label totalTeachersLabel;
    @FXML private Label exportsTodayLabel;
    @FXML private Label footerStatusLabel;

    // ========== State ==========

    private List<String> exportHistory = new ArrayList<>();
    private int exportsToday = 0;

    // ========== Initialization ==========

    @FXML
    public void initialize() {
        loadStatistics();
        updateFooterStatus("Ready");
    }

    private void loadStatistics() {
        Task<Void> loadTask = new Task<>() {
            @Override
            protected Void call() {
                long sections = courseSectionRepository.count();
                long students = studentRepository.count();
                long teachers = teacherRepository.count();

                Platform.runLater(() -> {
                    totalSectionsLabel.setText(String.valueOf(sections));
                    totalStudentsLabel.setText(String.valueOf(students));
                    totalTeachersLabel.setText(String.valueOf(teachers));
                    exportsTodayLabel.setText(String.valueOf(exportsToday));
                });

                return null;
            }
        };

        new Thread(loadTask).start();
    }

    // ========== Event Handlers ==========

    @FXML
    private void handleExport() {
        SISExportService.ExportFormat format = getSelectedFormat();
        SISExportService.ExportType exportType = getSelectedExportType();
        String outputPath = outputPathField.getText();

        if (outputPath == null || outputPath.trim().isEmpty()) {
            outputPath = null; // Will auto-generate
        }

        // Validate if requested
        if (validateDataCheckbox.isSelected()) {
            List<String> validationErrors = sisExportService.validateExportData(exportType);
            if (!validationErrors.isEmpty()) {
                showValidationErrors(validationErrors);
                Alert alert = new Alert(Alert.AlertType.WARNING);
                alert.setTitle("Validation Warnings");
                alert.setHeaderText("Data validation found " + validationErrors.size() + " issues");
                alert.setContentText("Do you want to continue with the export anyway?");

                ButtonType continueButton = new ButtonType("Continue");
                ButtonType cancelButton = new ButtonType("Cancel", ButtonBar.ButtonData.CANCEL_CLOSE);
                alert.getButtonTypes().setAll(continueButton, cancelButton);

                alert.showAndWait().ifPresent(response -> {
                    if (response == continueButton) {
                        performExport(format, exportType, outputPath);
                    }
                });
                return;
            }
        }

        performExport(format, exportType, outputPath);
    }

    private void performExport(SISExportService.ExportFormat format,
                               SISExportService.ExportType exportType,
                               String outputPath) {
        updateStatus("Exporting...");
        exportProgressBar.setVisible(true);
        exportProgressBar.setProgress(ProgressBar.INDETERMINATE_PROGRESS);

        final String finalOutputPath = outputPath;

        Task<SISExportResult> exportTask = new Task<>() {
            @Override
            protected SISExportResult call() {
                switch (exportType) {
                    case MASTER_SCHEDULE:
                    case COURSE_SECTIONS:
                        return sisExportService.exportMasterSchedule(format, finalOutputPath);
                    case STUDENT_SCHEDULES:
                        return sisExportService.exportAllStudentSchedules(format, finalOutputPath);
                    case TEACHER_SCHEDULES:
                        List<Long> teacherIds = new ArrayList<>();
                        teacherRepository.findAll().forEach(t -> teacherIds.add(t.getId()));
                        return sisExportService.exportTeacherSchedules(format, finalOutputPath, teacherIds);
                    case ENROLLMENTS:
                        return sisExportService.exportEnrollments(format, finalOutputPath);
                    default:
                        SISExportResult errorResult = new SISExportResult();
                        errorResult.addError("Unknown export type");
                        errorResult.setSuccess(false);
                        return errorResult;
                }
            }
        };

        exportTask.setOnSucceeded(event -> {
            SISExportResult result = exportTask.getValue();
            exportProgressBar.setVisible(false);

            if (result.isSuccess()) {
                updateStatus("Export successful: " + result.getRecordsExported() + " records");
                addToExportHistory(result);
                exportsToday++;
                exportsTodayLabel.setText(String.valueOf(exportsToday));

                // Notify via notification service
                if (notificationService != null) {
                    notificationService.notifyExportComplete(1L, format.getDisplayName(),
                            result.getFileName());
                }

                // Show success dialog
                Alert alert = new Alert(Alert.AlertType.INFORMATION);
                alert.setTitle("Export Complete");
                alert.setHeaderText("Export successful!");
                alert.setContentText(result.getSummary() + "\n\nFile: " + result.getFilePath());
                alert.showAndWait();

                // Open file if requested
                if (openAfterExportCheckbox.isSelected()) {
                    openFile(new File(result.getFilePath()));
                }
            } else {
                updateStatus("Export failed");
                showError("Export Failed", result.getErrors());
            }
        });

        exportTask.setOnFailed(event -> {
            exportProgressBar.setVisible(false);
            updateStatus("Export failed");
            showError("Export Error", List.of(exportTask.getException().getMessage()));
        });

        new Thread(exportTask).start();
    }

    @FXML
    private void handlePreview() {
        SISExportService.ExportFormat format = getSelectedFormat();
        SISExportService.ExportType exportType = getSelectedExportType();

        Task<String> previewTask = new Task<>() {
            @Override
            protected String call() {
                return sisExportService.previewExportData(format, exportType);
            }
        };

        previewTask.setOnSucceeded(event -> {
            previewTextArea.setText(previewTask.getValue());
        });

        new Thread(previewTask).start();
    }

    @FXML
    private void handleValidate() {
        SISExportService.ExportType exportType = getSelectedExportType();

        Task<List<String>> validationTask = new Task<>() {
            @Override
            protected List<String> call() {
                return sisExportService.validateExportData(exportType);
            }
        };

        validationTask.setOnSucceeded(event -> {
            List<String> errors = validationTask.getValue();
            showValidationResults(errors);
        });

        new Thread(validationTask).start();
    }

    @FXML
    private void handleBrowseOutputPath() {
        FileChooser fileChooser = new FileChooser();
        fileChooser.setTitle("Select Export File");

        SISExportService.ExportFormat format = getSelectedFormat();
        fileChooser.setInitialFileName(
                sisExportService.generateExportFilename(format, getSelectedExportType())
        );

        FileChooser.ExtensionFilter filter = new FileChooser.ExtensionFilter(
                format.getDisplayName() + " (*." + format.getFileExtension() + ")",
                "*." + format.getFileExtension()
        );
        fileChooser.getExtensionFilters().add(filter);

        File file = fileChooser.showSaveDialog(outputPathField.getScene().getWindow());
        if (file != null) {
            outputPathField.setText(file.getAbsolutePath());
        }
    }

    @FXML
    private void handleOpenExportFolder() {
        String exportDir = sisExportService.getDefaultExportPath(SISExportService.ExportFormat.GENERIC_CSV);
        File dir = new File(exportDir);

        if (!dir.exists()) {
            dir.mkdirs();
        }

        try {
            Desktop.getDesktop().open(dir);
        } catch (IOException e) {
            showError("Error", List.of("Could not open export folder: " + e.getMessage()));
        }
    }

    @FXML
    private void handleRefresh() {
        loadStatistics();
        updateFooterStatus("Refreshed");
    }

    @FXML
    private void handleClearHistory() {
        Alert confirm = new Alert(Alert.AlertType.CONFIRMATION);
        confirm.setTitle("Clear History");
        confirm.setHeaderText("Clear export history?");
        confirm.setContentText("This will only clear the display history, not delete exported files.");

        confirm.showAndWait().ifPresent(response -> {
            if (response == ButtonType.OK) {
                exportHistory.clear();
                exportHistoryList.getItems().clear();
                updateFooterStatus("History cleared");
            }
        });
    }

    // ========== Quick Export Handlers ==========

    @FXML
    private void handleQuickPowerSchoolStudents() {
        powerSchoolRadio.setSelected(true);
        studentSchedulesRadio.setSelected(true);
        handleExport();
    }

    @FXML
    private void handleQuickSkywardSections() {
        skywardRadio.setSelected(true);
        courseSectionsRadio.setSelected(true);
        handleExport();
    }

    @FXML
    private void handleQuickExcelMaster() {
        excelRadio.setSelected(true);
        masterScheduleRadio.setSelected(true);
        handleExport();
    }

    // ========== Helper Methods ==========

    private SISExportService.ExportFormat getSelectedFormat() {
        if (powerSchoolRadio.isSelected()) return SISExportService.ExportFormat.POWERSCHOOL;
        if (skywardRadio.isSelected()) return SISExportService.ExportFormat.SKYWARD;
        if (infiniteCampusRadio.isSelected()) return SISExportService.ExportFormat.INFINITE_CAMPUS;
        if (genericCSVRadio.isSelected()) return SISExportService.ExportFormat.GENERIC_CSV;
        if (excelRadio.isSelected()) return SISExportService.ExportFormat.EXCEL;
        return SISExportService.ExportFormat.POWERSCHOOL; // Default
    }

    private SISExportService.ExportType getSelectedExportType() {
        if (masterScheduleRadio.isSelected()) return SISExportService.ExportType.MASTER_SCHEDULE;
        if (studentSchedulesRadio.isSelected()) return SISExportService.ExportType.STUDENT_SCHEDULES;
        if (teacherSchedulesRadio.isSelected()) return SISExportService.ExportType.TEACHER_SCHEDULES;
        if (courseSectionsRadio.isSelected()) return SISExportService.ExportType.COURSE_SECTIONS;
        if (enrollmentsRadio.isSelected()) return SISExportService.ExportType.ENROLLMENTS;
        return SISExportService.ExportType.MASTER_SCHEDULE; // Default
    }

    private void showValidationResults(List<String> errors) {
        Platform.runLater(() -> {
            validationResultsContainer.getChildren().clear();

            if (errors.isEmpty()) {
                Label successLabel = new Label("✓ No validation errors found");
                successLabel.setStyle("-fx-text-fill: #4caf50; -fx-font-weight: bold;");
                validationResultsContainer.getChildren().add(successLabel);
            } else {
                Label errorCountLabel = new Label("⚠ Found " + errors.size() + " issues:");
                errorCountLabel.setStyle("-fx-text-fill: #f44336; -fx-font-weight: bold;");
                validationResultsContainer.getChildren().add(errorCountLabel);

                for (String error : errors.subList(0, Math.min(errors.size(), 10))) {
                    Label errorLabel = new Label("• " + error);
                    errorLabel.setWrapText(true);
                    errorLabel.setStyle("-fx-font-size: 10px; -fx-text-fill: #666;");
                    validationResultsContainer.getChildren().add(errorLabel);
                }

                if (errors.size() > 10) {
                    Label moreLabel = new Label("... and " + (errors.size() - 10) + " more");
                    moreLabel.setStyle("-fx-font-size: 10px; -fx-font-style: italic;");
                    validationResultsContainer.getChildren().add(moreLabel);
                }
            }
        });
    }

    private void showValidationErrors(List<String> errors) {
        showValidationResults(errors);
    }

    private void addToExportHistory(SISExportResult result) {
        String timestamp = LocalDate.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm"));
        String historyEntry = String.format("[%s] %s - %d records - %s",
                timestamp,
                result.getExportType(),
                result.getRecordsExported(),
                result.getFileName());

        exportHistory.add(0, historyEntry);
        exportHistoryList.getItems().add(0, historyEntry);

        // Keep only last 20 entries
        if (exportHistory.size() > 20) {
            exportHistory.remove(exportHistory.size() - 1);
            exportHistoryList.getItems().remove(exportHistoryList.getItems().size() - 1);
        }
    }

    private void updateStatus(String status) {
        Platform.runLater(() -> {
            statusLabel.setText(status);
            statusLabel.setStyle(status.contains("success") ? "-fx-text-fill: #4caf50;" : "-fx-text-fill: #000;");
        });
    }

    private void updateFooterStatus(String status) {
        Platform.runLater(() -> {
            footerStatusLabel.setText(status);
        });
    }

    private void showError(String title, List<String> errors) {
        Platform.runLater(() -> {
            Alert alert = new Alert(Alert.AlertType.ERROR);
            alert.setTitle(title);
            alert.setHeaderText("Export encountered errors");

            StringBuilder content = new StringBuilder();
            for (String error : errors) {
                content.append("• ").append(error).append("\n");
            }
            alert.setContentText(content.toString());

            alert.showAndWait();
        });
    }

    private void openFile(File file) {
        try {
            if (Desktop.isDesktopSupported()) {
                Desktop.getDesktop().open(file);
            }
        } catch (IOException e) {
            showError("Error", List.of("Could not open file: " + e.getMessage()));
        }
    }
}
