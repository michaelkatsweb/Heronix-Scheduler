<?xml version="1.0" encoding="UTF-8"?>

<?import javafx.geometry.Insets?>
<?import javafx.scene.control.*?>
<?import javafx.scene.layout.*?>
<?import javafx.collections.FXCollections?>
<?import java.lang.String?>

<VBox xmlns="http://javafx.com/javafx"
      xmlns:fx="http://javafx.com/fxml"
      fx:controller="com.eduscheduler.ui.controller.AdminGradebookController"
      styleClass="root"
      spacing="20">

    <padding>
        <Insets top="20" right="20" bottom="20" left="20"/>
    </padding>

    <!-- Header Section -->
    <HBox alignment="CENTER_LEFT" spacing="15" styleClass="card">
        <Label text="ðŸ“Š Administrator Gradebook" styleClass="label-title"/>
        <Region HBox.hgrow="ALWAYS"/>
        <Button text="âž• Add Transfer Grade" onAction="#handleAddTransferGrade"
                styleClass="button-primary"/>
        <Button text="ðŸ“¤ Export Grades" onAction="#handleExportGrades"
                styleClass="button-secondary"/>
        <Button text="ðŸ”„ Refresh" onAction="#handleRefresh"
                styleClass="button-secondary"/>
    </HBox>

    <!-- Filter Section -->
    <VBox spacing="15" styleClass="card" style="-fx-padding: 15;">
        <Label text="Filter &amp; Search" style="-fx-font-size: 16; -fx-font-weight: bold;"/>

        <HBox spacing="15" alignment="CENTER_LEFT" styleClass="filter-panel" style="-fx-padding: 10;">
            <!-- Row 1: Basic Filters -->
            <VBox spacing="5">
                <Label text="Academic Year:" style="-fx-font-weight: bold;"/>
                <ComboBox fx:id="academicYearComboBox" promptText="Select Year" prefWidth="150"
                         onAction="#handleFilterChange"/>
            </VBox>

            <VBox spacing="5">
                <Label text="Term:" style="-fx-font-weight: bold;"/>
                <ComboBox fx:id="termComboBox" promptText="All Terms" prefWidth="150"
                         onAction="#handleFilterChange"/>
            </VBox>

            <VBox spacing="5">
                <Label text="Course:" style="-fx-font-weight: bold;"/>
                <ComboBox fx:id="courseComboBox" promptText="All Courses" prefWidth="200"
                         onAction="#handleFilterChange"/>
            </VBox>

            <VBox spacing="5">
                <Label text="Teacher:" style="-fx-font-weight: bold;"/>
                <ComboBox fx:id="teacherComboBox" promptText="All Teachers" prefWidth="180"
                         onAction="#handleFilterChange"/>
            </VBox>
        </HBox>

        <HBox spacing="15" alignment="CENTER_LEFT" styleClass="filter-panel" style="-fx-padding: 10;">
            <!-- Row 2: Advanced Filters -->
            <VBox spacing="5">
                <Label text="Student Search:" style="-fx-font-weight: bold;"/>
                <TextField fx:id="studentSearchField" promptText="Search by name or ID..."
                          prefWidth="250" onKeyReleased="#handleFilterChange"/>
            </VBox>

            <VBox spacing="5">
                <Label text="Grade Range:" style="-fx-font-weight: bold;"/>
                <HBox spacing="5">
                    <ComboBox fx:id="minGradeComboBox" promptText="Min" prefWidth="80"
                             onAction="#handleFilterChange"/>
                    <Label text="to" alignment="CENTER" minWidth="20"/>
                    <ComboBox fx:id="maxGradeComboBox" promptText="Max" prefWidth="80"
                             onAction="#handleFilterChange"/>
                </HBox>
            </VBox>

            <VBox spacing="5">
                <Label text="Status:" style="-fx-font-weight: bold;"/>
                <HBox spacing="10">
                    <CheckBox fx:id="showFailingCheckBox" text="Failing" onAction="#handleFilterChange"/>
                    <CheckBox fx:id="showIncompleteCheckBox" text="Incomplete" onAction="#handleFilterChange"/>
                    <CheckBox fx:id="showTransferCheckBox" text="Transfer" onAction="#handleFilterChange"/>
                </HBox>
            </VBox>

            <Region HBox.hgrow="ALWAYS"/>

            <VBox spacing="5" alignment="BOTTOM_RIGHT">
                <Button text="Clear Filters" onAction="#handleClearFilters"
                       styleClass="button" style="-fx-padding: 6 12;"/>
            </VBox>
        </HBox>

        <!-- Summary Stats -->
        <HBox spacing="30" alignment="CENTER_LEFT" styleClass="info-panel-primary" style="-fx-padding: 10;">
            <VBox spacing="3">
                <Label text="Total Grades" styleClass="text-muted" style="-fx-font-size: 11;"/>
                <Label fx:id="totalGradesLabel" text="0" style="-fx-font-size: 20; -fx-font-weight: bold;"/>
            </VBox>
            <Separator orientation="VERTICAL"/>
            <VBox spacing="3">
                <Label text="Average GPA" styleClass="text-muted" style="-fx-font-size: 11;"/>
                <Label fx:id="averageGpaLabel" text="0.00" style="-fx-font-size: 20; -fx-font-weight: bold;"/>
            </VBox>
            <Separator orientation="VERTICAL"/>
            <VBox spacing="3">
                <Label text="Failing Grades" styleClass="text-muted" style="-fx-font-size: 11;"/>
                <Label fx:id="failingGradesLabel" text="0" styleClass="danger-text" style="-fx-font-size: 20; -fx-font-weight: bold;"/>
            </VBox>
            <Separator orientation="VERTICAL"/>
            <VBox spacing="3">
                <Label text="Recent Edits" styleClass="text-muted" style="-fx-font-size: 11;"/>
                <Label fx:id="recentEditsLabel" text="0" styleClass="accent-text" style="-fx-font-size: 20; -fx-font-weight: bold;"/>
            </VBox>
        </HBox>
    </VBox>

    <!-- Grades Table -->
    <VBox VBox.vgrow="ALWAYS" spacing="10" styleClass="card" style="-fx-padding: 15;">
        <HBox alignment="CENTER_LEFT" spacing="10">
            <Label text="Grade Records" style="-fx-font-size: 16; -fx-font-weight: bold;"/>
            <Region HBox.hgrow="ALWAYS"/>
            <Label fx:id="recordCountLabel" text="Showing: 0 records" styleClass="text-secondary"/>
            <Button text="ðŸ“ Bulk Edit" onAction="#handleBulkEdit"
                   styleClass="button-warning" style="-fx-padding: 6 12;"/>
        </HBox>

        <TableView fx:id="gradesTable" VBox.vgrow="ALWAYS">
            <columns>
                <TableColumn fx:id="gradeIdColumn" text="ID" prefWidth="60" minWidth="50"/>
                <TableColumn fx:id="studentNameColumn" text="Student Name" prefWidth="180" minWidth="150"/>
                <TableColumn fx:id="studentIdColumn" text="Student ID" prefWidth="100" minWidth="80"/>
                <TableColumn fx:id="courseColumn" text="Course" prefWidth="200" minWidth="150"/>
                <TableColumn fx:id="teacherColumn" text="Teacher" prefWidth="150" minWidth="120"/>
                <TableColumn fx:id="termColumn" text="Term" prefWidth="100" minWidth="80"/>
                <TableColumn fx:id="yearColumn" text="Year" prefWidth="80" minWidth="60"/>
                <TableColumn fx:id="letterGradeColumn" text="Letter" prefWidth="80" minWidth="60"/>
                <TableColumn fx:id="numericalGradeColumn" text="Percentage" prefWidth="100" minWidth="80"/>
                <TableColumn fx:id="gpaColumn" text="GPA" prefWidth="70" minWidth="60"/>
                <TableColumn fx:id="creditsColumn" text="Credits" prefWidth="80" minWidth="60"/>
                <TableColumn fx:id="statusColumn" text="Status" prefWidth="100" minWidth="80"/>
                <TableColumn fx:id="lastEditedColumn" text="Last Edited" prefWidth="120" minWidth="100"/>
                <TableColumn fx:id="actionsColumn" text="Actions" prefWidth="180" minWidth="150"/>
            </columns>

            <placeholder>
                <VBox alignment="CENTER" spacing="10" style="-fx-padding: 50;">
                    <Label text="ðŸ“Š" style="-fx-font-size: 48;"/>
                    <Label text="No grade records found" styleClass="text-secondary" style="-fx-font-size: 16;"/>
                    <Label text="Adjust filters or add transfer grades to get started" styleClass="text-muted" style="-fx-font-size: 12;"/>
                </VBox>
            </placeholder>
        </TableView>

        <!-- Pagination -->
        <HBox alignment="CENTER" spacing="10">
            <Button text="Â« First" onAction="#handleFirstPage" styleClass="button" style="-fx-padding: 5 10;"/>
            <Button text="â€¹ Previous" onAction="#handlePreviousPage" styleClass="button" style="-fx-padding: 5 10;"/>
            <Label fx:id="pageInfoLabel" text="Page 1 of 1" styleClass="text-secondary" style="-fx-font-weight: bold;"/>
            <Button text="Next â€º" onAction="#handleNextPage" styleClass="button" style="-fx-padding: 5 10;"/>
            <Button text="Last Â»" onAction="#handleLastPage" styleClass="button" style="-fx-padding: 5 10;"/>
            <Separator orientation="VERTICAL"/>
            <Label text="Records per page:" styleClass="text-secondary"/>
            <ComboBox fx:id="pageSizeComboBox" onAction="#handlePageSizeChange" prefWidth="80"/>
            <!-- Note: Items are populated in controller initialize() method -->
        </HBox>
    </VBox>

    <!-- Audit Log Section (Collapsible) -->
    <TitledPane text="ðŸ“œ Recent Grade Changes (Audit Log)" collapsible="true" expanded="false"
                styleClass="card">
        <VBox spacing="10" style="-fx-padding: 10;">
            <HBox spacing="10" alignment="CENTER_LEFT">
                <Label text="Show last:" styleClass="text-secondary"/>
                <ComboBox fx:id="auditLogLimitComboBox" onAction="#handleAuditLogRefresh" prefWidth="100">
                    <items>
                        <FXCollections fx:factory="observableArrayList">
                            <String fx:value="10"/>
                            <String fx:value="25"/>
                            <String fx:value="50"/>
                            <String fx:value="100"/>
                        </FXCollections>
                    </items>
                </ComboBox>
                <Label text="changes" styleClass="text-secondary"/>
                <Region HBox.hgrow="ALWAYS"/>
                <Button text="ðŸ” View Full Audit Log" onAction="#handleViewFullAuditLog"
                       styleClass="button-secondary" style="-fx-padding: 5 10;"/>
            </HBox>

            <TableView fx:id="auditLogTable" prefHeight="250">
                <columns>
                    <TableColumn fx:id="auditTimestampColumn" text="Timestamp" prefWidth="150" minWidth="120"/>
                    <TableColumn fx:id="auditAdminColumn" text="Admin" prefWidth="150" minWidth="120"/>
                    <TableColumn fx:id="auditStudentColumn" text="Student" prefWidth="150" minWidth="120"/>
                    <TableColumn fx:id="auditCourseColumn" text="Course" prefWidth="180" minWidth="150"/>
                    <TableColumn fx:id="auditFieldColumn" text="Field Changed" prefWidth="120" minWidth="100"/>
                    <TableColumn fx:id="auditOldValueColumn" text="Old Value" prefWidth="100" minWidth="80"/>
                    <TableColumn fx:id="auditNewValueColumn" text="New Value" prefWidth="100" minWidth="80"/>
                    <TableColumn fx:id="auditReasonColumn" text="Reason" prefWidth="250" minWidth="200"/>
                </columns>

                <placeholder>
                    <VBox alignment="CENTER" spacing="10" style="-fx-padding: 30;">
                        <Label text="ðŸ“œ" style="-fx-font-size: 36;"/>
                        <Label text="No recent audit log entries" styleClass="text-muted" style="-fx-font-size: 12;"/>
                    </VBox>
                </placeholder>
            </TableView>
        </VBox>
    </TitledPane>

    <!-- Status Bar -->
    <HBox alignment="CENTER_LEFT" spacing="10" styleClass="card" style="-fx-padding: 10;">
        <Label text="â—" styleClass="success-text" style="-fx-font-size: 14;"/>
        <Label text="Administrator Gradebook loaded successfully" styleClass="text-secondary"/>
        <Region HBox.hgrow="ALWAYS"/>
        <Label fx:id="lastRefreshLabel" text="Last refresh: Never" styleClass="text-muted" style="-fx-font-size: 11;"/>
    </HBox>

</VBox>
